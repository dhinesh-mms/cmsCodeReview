const Common=require("../editor-core/common.js"),PlayerHelper=require("../helpers/player-helper.js"),checkCondition=function(e,t,a,n=!0){return"ne"===e&&""===t||"eq"===e&&a==t||"neq"===e&&a!=t||"gt"===e&&!Number.isNaN(parseInt(a))&&!Number.isNaN(parseInt(t))&&parseInt(a)>parseInt(t)||"lt"===e&&!Number.isNaN(parseInt(a))&&!Number.isNaN(parseInt(t))&&parseInt(a)<parseInt(t)||"egt"===e&&!Number.isNaN(parseInt(a))&&!Number.isNaN(parseInt(t))&&parseInt(a)>=parseInt(t)||"elt"===e&&!Number.isNaN(parseInt(a))&&!Number.isNaN(parseInt(t))&&parseInt(a)<=parseInt(t)||"isTopLevel"===e&&t==n};window.forms={createFields:function(e,t,a,n,i=[],l,o=!1){for(const r in e)if(e.hasOwnProperty(r)){const s=e[r];if(!0===s.skip)continue;if(null===s.value&&void 0!==s.default&&(s.value=s.default),s.visibility.length){const e=[];for(let t=0;t<s.visibility.length;t++){const a=s.visibility[t],n={type:a.type,conditions:[]};for(let e=0;e<a.conditions.length;e++){const t=a.conditions[e];n.conditions.push({field:t.field,type:t.type,value:t.value})}e.push(n)}s.visibility=JSON.stringify(e)}if("datasetSelector"===s.type&&(s.datasetSearchUrl=urlsForApi.dataset.search.url,""==s.value?(s.initialValue=null,s.initialKey=null):(s.initialValue=s.value,s.initialKey="dataSetId")),"datasetField"===s.type&&(""==s.value?(s.initialValue=null,s.initialKey=null):(s.initialValue=s.value,s.initialKey="datasetField")),"menuBoardSelector"===s.type&&(s.menuBoardSearchUrl=urlsForApi.menuBoard.search.url,""==s.value?(s.initialValue=null,s.initialKey=null):(s.initialValue=s.value,s.initialKey="menuId")),"menuBoardCategorySelector"===s.type&&(s.menuBoardCategorySearchUrl=urlsForApi.menuBoard.categorySearch.url,""==s.value?(s.initialValue=null,s.initialKey=null):(s.initialValue=s.value,s.initialKey="menuCategoryId")),"mediaSelector"===s.type&&(s.mediaSearchUrl=urlsForApi.library.get.url,""==s.value?(s.initialValue=null,s.initialKey=null):(s.initialValue=s.value,s.initialKey="mediaId")),"fontSelector"===s.type&&(s.fontsSearchUrl=getFontsUrl+"?length=10000"),"commandSelector"===s.type&&(s.commandSearchUrl=urlsForApi.command.search.url,""==s.value?(s.initialValue=null,s.initialKey=null):(s.initialValue=s.value,s.initialKey="code")),"playlistMixer"===s.type&&(s.playlistId=n),"color"===s.type&&""!=s.format&&(s.colorFormat=s.format),"connectorProperties"===s.type&&(s.connectorPropertiesUrl=urlsForApi.connectorProperties.search.url.replace(":id",a)+"?propertyId="+s.id,""==s.value?(s.initialValue=null,s.initialKey=null):(s.initialValue=s.value,s.initialKey=s.id)),s.name=s.id,a&&(s.id=a+"_"+s.id),s.variant&&"autocomplete"===s.variant&&(s.isAutoComplete=!0),templates.forms.hasOwnProperty(s.type)){const e=$(templates.forms[s.type](Object.assign({},s,{trans:"undefined"==typeof propertiesPanelTrans?{}:propertiesPanelTrans})));let a=$(t);if(s.propertyGroupId){const e=i.find((e=>e.id===s.propertyGroupId));e&&($(t).find("#"+s.propertyGroupId).length?a=$(t).find("#"+s.propertyGroupId+" .field-container"):(a.append($(templates.forms.group({id:e.id,title:e.title,helpText:e.helpText,expanded:e.expanded}))),a=$($(t).find("#"+s.propertyGroupId)).find(".field-container")))}if(o?a.prepend(e):a.append(e),s.helpText&&0===e.find(".input-info-container .xibo-help-text").length&&e.find(".input-info-container").append($(templates.forms.addOns.helpText({helpText:s.helpText}))),s.customPopOver&&e.find(".input-info-container").append($(templates.forms.addOns.customPopOver({content:s.customPopOver}))),s.playerCompatibility&&e.find(".input-info-container").append($(templates.forms.addOns.playerCompatibility(s.playerCompatibility))),s.variant&&"dateFormat"===s.variant&&(e.find("label.control-label").append($(templates.forms.addOns.dateFormatHelperPopup({content:Handlebars.compile($("#php-date-format-table").html())}))),e.find('[data-toggle="popover"]').popover({sanitize:!1,trigger:"manual"}).on("mouseenter",(function(e){$(e.currentTarget).popover("show")}))),"datasetField"===s.type&&void 0!==s.value&&String(s.value).length>0&&e.find("select").attr("data-value",s.value),s.dependsOn&&!e.attr("data-depends-on")&&e.attr("data-depends-on",s.dependsOn),s.visibility.length&&!e.attr("data-visibility")&&e.attr("data-visibility",s.visibility),s?.validation?.tests?.length&&!e.attr("data-is-required")){let t=!1;$.each(s.validation.tests,(function(a,n){$.each(n.conditions,(function(a,n){"required"!==n?.type||t||(e.attr("data-is-required",!0),s.isRequired=!0,t=!0)}))}))}l&&e.find("[name]").addClass(l)}else console.error("Form type not found: "+s.type)}Common.reloadTooltips($(t),{position:"left"})},initFields:function(e,t,a,n=!1){const i=this,l=function(t,a){return a?$(a).is(t)?$(a):$():$(e).find(t)};l(".dropdown-input-group",t).each((function(e,t){$(t).find("select").find("option[data-content]").each((function(e,t){const a=$(t),n=$(a.data("content")),i=n.find("img");i.attr("src",assetDownloadUrl.replace(":assetId",i.attr("src"))),a.data("content",n.html())}))})),l(".dataset-order-clause",t).each((function(e,t){const a=$(t),l=a.data("depends-on-value");l&&$.ajax({url:urlsForApi.dataset.search.url,type:"GET",data:{dataSetId:l}}).done((function(e){const t=e.data[0].columns,l=a.find(".order-clause-container");if(0==l.length)return;const o=a.find("#input_"+a.data("order-id")),r=o.val()?JSON.parse(o.val()):[],s=function(){const e=[];l.find(".order-clause-row").each((function(t,a){const n=$(a),i=n.find(".order-clause").val(),l=n.find(".order-clause-direction").val();i&&e.push({orderClause:i,orderClauseDirection:l})})),o.val(JSON.stringify(e)).trigger("change")};l.empty();const c=formHelpers.getTemplate("dataSetOrderClauseTemplate"),d=datasetQueryBuilderTranslations.ascTitle,p=datasetQueryBuilderTranslations.descTitle;if(0==r.length){const e={columns:t,title:"1",orderClause:"",orderClauseAsc:"",orderClauseDesc:"",buttonGlyph:"fa-plus",ascTitle:d,descTitle:p};l.append(c(e))}else{let e=0;$.each(r,(function(a,n){e++;const i="ASC"==n.orderClauseDirection,o={columns:t,title:e,orderClause:n.orderClause,orderClauseAsc:i,orderClauseDesc:!i,buttonGlyph:1==e?"fa-plus":"fa-minus",ascTitle:d,descTitle:p};l.append(c(o))}))}n?i.makeFormReadOnly(a):(l.on("click","button",(function(e){if(e.preventDefault(),$(e.currentTarget).find("i").hasClass("fa-plus")){const e={columns:t,title:l.find(".form-inline").length+1,orderClause:"",orderClauseAsc:"",orderClauseDesc:"",buttonGlyph:"fa-minus",ascTitle:d,descTitle:p};l.append(c(e))}else $(e.currentTarget).closest(".form-inline").remove();s()})),a.on("change",'select:not([type="hidden"])',(function(){s()})))})).fail((function(e,t,a){console.error(e,t,a)}))})),l(".dataset-column-selector",t).each((function(e,t){const a=$(t),i=a.data("depends-on-value");i&&$.ajax({url:urlsForApi.dataset.search.url,type:"GET",data:{dataSetId:i}}).done((function(e){const t=e.data[0].columns,i=a.find("#columnsOut"),l=a.find("#columnsIn");if(0==i.length||0==l.length)return;const o=a.find("#input_"+a.data("select-id")),r=o.val()?JSON.parse(o.val()):[],s=function(e=!1){const t=[];l.find("li").each((function(e,a){const n=$(a).attr("id");t.push(Number(n))})),a.find(".temp").remove(),$.each(t,(function(e,t){a.append('<input type="hidden" class="temp" name="dataSetColumnId[]" value="'+t+'" />')})),o.val(JSON.stringify(t)).trigger("change",[{skipSave:e}])};i.empty(),l.empty();const c=datasetColumnSelectorTranslations.colAvailable,d=datasetColumnSelectorTranslations.colSelected;a.find(".col-out-title").text(c),a.find(".col-in-title").text(d);const p=[],u=[];$.each(t,(function(e,t){r.includes(t.dataSetColumnId)?u.push(t):p.push(t)}));const f=a.find("#columnsOut");$.each(p,(function(e,t){f.append('<li class="li-sortable" id="'+t.dataSetColumnId+'">'+t.heading+"</li>")}));const m=a.find("#columnsIn");$.each(u,(function(e,t){m.append('<li class="li-sortable" id="'+t.dataSetColumnId+'">'+t.heading+"</li>")})),n||(a.find("#columnsIn, #columnsOut").sortable({connectWith:".connectedSortable",dropOnEmpty:!0,update:function(){s()}}).disableSelection(),a.find(".li-sortable").on("dblclick",(function(e){const t=$(e.currentTarget);t.appendTo(t.parent().is("#columnsIn")?f:m),s()}))),s(!0)})).fail((function(e,t,a){console.error(e,t,a)}))})),l(".dataset-field-selector",t).each((function(t,a){const n=$(a),i=n.find("select"),l=$(e).find('input[name="dataTypeId"]'),o=n.data("depends-on-value");o&&(n.show(),$.ajax({url:urlsForApi.dataset.search.url,type:"GET",data:{dataSetId:o}}).done((function(e){const t=e.data[0].columns||[];if(l.length>0&&t.length>0){const e=(a=t,o=l.val(),a.reduce((function(e,t){const a=String(o);let n=[];return n=-1!==a.indexOf(",")?a.split(","):[a],-1!==n.indexOf(String(t.dataTypeId))?[...e,t]:e}),[])||[]);e.length>0?(i.find("option[value]").remove(),$.each(e,(function(e,t){i.append($('<option value="'+t.heading+'">'+t.heading+"</option>"))})),void 0!==i.data("value")?i.val(i.data("value")).trigger("change",[{skipSave:!0}]):(1===e.length||e.length>1)&&i.val(e[0].heading).trigger("change")):n.hide()}var a,o})))})),l(".dataset-filter-clause",t).each((function(e,t){const a=$(t),l=a.data("depends-on-value");l&&$.ajax({url:urlsForApi.dataset.search.url,type:"GET",data:{dataSetId:l}}).done((function(e){const t=e.data[0].columns,l=a.find(".filter-clause-container");if(0==l.length)return;const o=a.find("#input_"+a.data("filter-id")),r=o.val()?JSON.parse(o.val()):[],s=function(){const e=[];l.find(".filter-clause-row").each((function(t,a){const n=$(a),i=n.find(".filter-clause").val(),l=n.find(".filter-clause-operator").val(),o=n.find(".filter-clause-criteria").val(),r=n.find(".filter-clause-value").val();i&&e.push({filterClause:i,filterClauseOperator:l,filterClauseCriteria:o,filterClauseValue:r})})),o.val(JSON.stringify(e)).trigger("change")};l.empty();const c=formHelpers.getTemplate("dataSetFilterClauseTemplate"),d=datasetQueryBuilderTranslations.filterOptions,p=datasetQueryBuilderTranslations.filterOperatorOptions;if(0==r.length){const e={columns:t,filterOptions:d,filterOperatorOptions:p,title:"1",filterClause:"",filterClauseOperator:"AND",filterClauseCriteria:"",filterClauseValue:"",buttonGlyph:"fa-plus"};l.append(c(e))}else{let e=0;$.each(r,(function(a,n){e++;const i={columns:t,filterOptions:d,filterOperatorOptions:p,title:e,filterClause:n.filterClause,filterClauseOperator:n.filterClauseOperator,filterClauseCriteria:n.filterClauseCriteria,filterClauseValue:n.filterClauseValue,buttonGlyph:1==e?"fa-plus":"fa-minus"};l.append(c(i))}))}n?i.makeFormReadOnly(a):(l.on("click","button",(function(e){if(e.preventDefault(),$(e.currentTarget).find("i").hasClass("fa-plus")){const e={columns:t,filterOptions:d,filterOperatorOptions:p,title:l.find(".form-inline").length+1,filterClause:"",filterClauseOperator:"AND",filterClauseCriteria:"",filterClauseValue:"",buttonGlyph:"fa-minus"};l.append(c(e))}else $(e.currentTarget).closest(".form-inline").remove();s()})),a.on("change",'select:not([type="hidden"]), input:not([type="hidden"])',(function(e){s()})))})).fail((function(e,t,a){console.error(e,t,a)}))})),l(".ticker-tag-selector",t).each((function(e,t){const a=$(t),l={title:"text",summary:"text",content:"text",author:"text",permalink:"text",link:"text",date:"date",publishedDate:"date",image:"image"},o=a.find("#tagsOut"),r=a.find("#tagsIn");if(0==o.length||0==r.length)return;const s=a.find("#input_"+a.data("select-id")),c=s.val()?JSON.parse(s.val()):[],d=Object.keys(c),p=_.debounce((function(e=!1){const t=[],n=s.val()?JSON.parse(s.val()):[];r.find("li").each((function(e,a){const n=$(a).attr("id");t.push(n)})),a.find(".ticker-tag-styles .ticker-tag-style").remove(),t.forEach((e=>{const t=$(templates.forms.tickerTagStyle({id:e,type:l[e],value:n[e],trans:tickerTagSelectorTranslations,fontsSearchUrl:getFontsUrl+"?length=10000"}));t.appendTo(a.find(".ticker-tag-styles")),t.off().on("change inputChange",u)})),i.initFields(a.find(".ticker-tag-styles")),u()}),100),u=_.debounce((function(){const e={};a.find(".ticker-tag-style").each((function(t,a){const n=$(a).data("component-id");e[n]={};const i=$(a).find(".ticker-tag-style-property");e[n].tagType=l[n],i.find("select, input").each((function(t,a){const i=$(a).data("tag-style-input"),l="checkbox"===$(a).attr("type")?$(a).is(":checked"):$(a).val();e[n][i]=l}))})),s.val(JSON.stringify(e)).trigger("change")}),100);o.empty(),r.empty();const f=tickerTagSelectorTranslations.tagAvailable,m=tickerTagSelectorTranslations.tagSelected;a.find(".col-out-title").text(f),a.find(".col-in-title").text(m);const h=[],g=[];$.each(Object.keys(l),(function(e,t){d.includes(t)?g.push(t):h.push(t)}));const y=a.find("#tagsOut");$.each(h,(function(e,t){const a=$('<li class="li-sortable" id="'+t+'" data-tag-type="'+l[t]+'">'+tickerTagSelectorTranslations[t]+"</li>").data("tag-type",l[t]);y.append(a)}));const v=a.find("#tagsIn");$.each(g,(function(e,t){const a=$('<li class="li-sortable" id="'+t+'" data-tag-type="'+l[t]+'">'+tickerTagSelectorTranslations[t]+"</li>");v.append(a)})),n||(a.find("#tagsIn, #tagsOut").sortable({connectWith:".connectedSortable",dropOnEmpty:!0,receive:p,update:p}).disableSelection(),a.find(".li-sortable").on("dblclick",(function(e){const t=$(e.currentTarget);t.appendTo(t.parent().is("#tagsIn")?y:v),p()}))),p(!0)})),l(".dataset-column-style-selector",t).each((function(e,t){const a=$(t),l=a.data("depends-on-value");l&&$.ajax({url:urlsForApi.dataset.search.url,type:"GET",data:{dataSetId:l}}).done((function(e){const t=e.data[0].columns,l={3:"date",5:"image"},o=function(e){return t.find((t=>t.dataSetColumnId==e))},r=a.find("#colsOut"),s=a.find("#colsIn");if(0==r.length||0==s.length)return;const c=a.find("#input_"+a.data("select-id")),d=c.val()?JSON.parse(c.val()):[],p=Object.keys(d),u=_.debounce((function(e=!1){const t=[],n=c.val()?JSON.parse(c.val()):[];s.find("li").each((function(e,a){const n=$(a).attr("id"),i=(r=$(a).data("colType"),l[r]?l[r]:"text");var r;const s=o(n);t.push({id:n,type:i,name:s.heading})})),a.find(".dataset-column-styles .dataset-col-style").remove(),t.forEach((e=>{const t=$(templates.forms.datasetColStyle({id:e.id,type:e.type,name:e.name,value:n[e.id],trans:datasetColStyleSelectorTranslations,fontsSearchUrl:getFontsUrl+"?length=10000"}));t.appendTo(a.find(".dataset-column-styles")),t.off().on("change inputChange",(function(){f()}))})),i.initFields(a.find(".dataset-column-styles")),f()}),100),f=_.debounce((function(){const e={};let t=0;a.find(".dataset-col-style").each((function(a,n){const i=$(n).data("component-id");e[i]={};const l=$(n).find(".dataset-col-style-property");e[i].playOrder=t,t++,e[i].colId=i,l.find("select, input").each((function(t,a){const n=$(a).data("dataset-col-style-input"),l="checkbox"===$(a).attr("type")?$(a).is(":checked"):$(a).val();e[i][n]=l}))})),c.val(JSON.stringify(e)).trigger("change")}),100);r.empty(),s.empty();const m=datasetColStyleSelectorTranslations.colAvailable,h=datasetColStyleSelectorTranslations.colSelected;a.find(".col-out-title").text(m),a.find(".col-in-title").text(h);const g=[],y=[];$.each(Object.keys(t),(function(e,a){const n=t[a].dataSetColumnId;p.find((e=>n==e))?y.push(n):g.push(n)}));const v=a.find("#colsOut");$.each(g,(function(e,t){const a=o(t),n=$('<li class="li-sortable" id="'+a.dataSetColumnId+'" data-col-type="'+a.dataTypeId+'">'+a.heading+"</li>").data("col-type",a.dataTypeId);v.append(n)}));const T=a.find("#colsIn");$.each(y,(function(e,t){const a=o(t),n=$('<li class="li-sortable" id="'+a.dataSetColumnId+'" data-col-type="'+a.dataTypeId+'">'+a.heading+"</li>");T.append(n)})),n||(a.find("#colsIn, #colsOut").sortable({connectWith:".connectedSortable",dropOnEmpty:!0,receive:u,update:u}).disableSelection(),a.find(".li-sortable").on("dblclick",(function(e){const t=$(e.currentTarget);t.appendTo(t.parent().is("#colsIn")?v:T),u()}))),u(!0)})).fail((function(e,t,a){console.error(e,t,a)}))})),l(".languageSelect",t).each((function(t,a){const n=$(a).find("select.form-control");if($(a).hasClass("momentLocales")){const e=moment.locales().sort(),t=n.val();n.find("option").remove(),e.unshift("");for(let a=0;a<e.length;a++){const i=e[a],l=momentLocalesTrans[i]||i,o=$(`<option value="${i}">${i} - ${l}</option>`);t==i&&o.prop("selected",!0),o.appendTo(n)}}makeLocalSelect(n,e)})),l(".playlist-mixer",t).each((function(e,t){const a=$(t);function l(e,t){const a=t.find(".subplaylist-id");a.data("fieldId")?$.ajax({method:"GET",url:urlsForApi.playlist.get.url+"?playlistId="+a.data("fieldId"),success:function(t){t.data&&t.data.length>0?(a.append('<option value="'+t.data[0].playlistId+'" data-tags="'+t.data[0].tags+'" selected>'+t.data[0].name+"</option>"),o(e,a)):(a.parent().append('<input type="hidden" value="'+a.data("fieldId")+'" name="subPlaylistId[]"><span title="'+playlistMixerTranslations.noPermission+'"><i class="fa fa-lock"></i>&nbsp;'+playlistMixerTranslations.playlistId+" "+a.data("fieldId")+"</span>"),a.remove()),n&&i.makeFormReadOnly(e)},error:function(){a.parent().append('{% trans "An unknown error has occurred. Please refresh" %}')}}):o(e,a),t.find('select[name="spotFill[]"]').select2({templateResult:function(e){return e.id?$(e.element).data().templateResult:e.text},dropdownAutoWidth:!0,minimumResultsForSearch:-1})}function o(e,t){t.select2({dropdownAutoWidth:!0,ajax:{url:urlsForApi.playlist.get.url+"?notPlaylistId="+e.data("playlistId"),dataType:"json",delay:250,data:function(e){const t={start:0,length:10,name:e.term};return null!=e.page&&(t.start=10*(e.page-1)),t},processResults:function(t,a){const n=[];$.each(t.data,(function(e,t){n.push({id:t.playlistId,text:t.name})}));let i=a.page||1;return i=i>1?i-1:i,1===i&&n.length<=0&&e.find(".sub-playlist-no-playlists-message").removeClass("d-none"),{results:n,pagination:{more:10*i<t.recordsTotal}}}}})}const r=a.find("#input_"+a.data("mixer-id")),s=r.val()?JSON.parse(r.val()):[],c=a.find(".mixer-playlist-container");if(0==c.length)return;const d=function(){const e=[];c.find(".subplaylist-item-row").each((function(t,a){const n=$(a),i=n.find(".subplaylist-id").val(),l=n.find(".subplaylist-spots").val(),o=n.find(".subplaylist-spots-length").val(),r=n.find(".subplaylist-spots-fill").val();i&&e.push({rowNo:t+1,playlistId:i,spots:l,spotLength:o,spotFill:r})})),r.val(JSON.stringify(e)).trigger("xiboInputChange")};c.empty();const p=formHelpers.getTemplate("subPlaylistContainerTemplate");c.append(p({trans:playlistMixerTranslations}));const u=formHelpers.getTemplate("subPlaylistFormTemplate");if(0==s.length){const e={playlistId:"",spots:"",spotLength:"",spotFill:"",fillTitle:playlistMixerTranslations.fillTitle,padTitle:playlistMixerTranslations.padTitle,repeatTitle:playlistMixerTranslations.repeatTitle,fillHelpText:playlistMixerTranslations.fillHelpText,padHelpText:playlistMixerTranslations.padHelpText,repeatHelpText:playlistMixerTranslations.repeatHelpText};c.find(".subplaylist-items-content").append(u(e))}else $.each(s,(function(e,t){const a={playlistId:t.playlistId,spots:t.spots,spotLength:t.spotLength,spotFill:t.spotFill,fillTitle:playlistMixerTranslations.fillTitle,padTitle:playlistMixerTranslations.padTitle,repeatTitle:playlistMixerTranslations.repeatTitle,fillHelpText:playlistMixerTranslations.fillHelpText,padHelpText:playlistMixerTranslations.padHelpText,repeatHelpText:playlistMixerTranslations.repeatHelpText};c.find(".subplaylist-items-content").append(u(a))}));c.on("click",".subplaylist-item-btn",(function(e){if(e.preventDefault(),$(e.currentTarget).find("i").hasClass("fa-plus")){const e={playlistId:"",spots:"",spotLength:"",subPlaylistIdSpotFill:"",fillTitle:playlistMixerTranslations.fillTitle,padTitle:playlistMixerTranslations.padTitle,repeatTitle:playlistMixerTranslations.repeatTitle,fillHelpText:playlistMixerTranslations.fillHelpText,padHelpText:playlistMixerTranslations.padHelpText,repeatHelpText:playlistMixerTranslations.repeatHelpText},t=$(u(e)).appendTo(c.find(".subplaylist-items-content"));l(a,t)}else $(e.currentTarget).closest(".subplaylist-item-row").remove();d()})),c.find(".subplaylist-item-row").each((function(e,t){l(a,$(t))})),a.on("change","select, input",(function(){d()})),c.sortable({axis:"y",items:".subplaylist-item-row",handle:".subplaylist-item-sort",containment:"parent",update:function(){d()}})})),l(".xibo-code-input",t).each((function(e,t){const a=$(t).find(".code-input"),n=a.val(),i=a.data("codeType");void 0===window.codeEditors&&(window.codeEditors={});const l=window.codeEditors[a.attr("id")]=monaco.editor.create($(t).find(".code-input-editor")[0],{value:n,fontSize:12,theme:"vs-dark",language:i,lineNumbers:"off",glyphMargin:!1,folding:!1,lineDecorationsWidth:0,lineNumbersMinChars:0,automaticLayout:!0,minimap:{enabled:!1}});l.onDidChangeModelContent((()=>{a.val(l.getValue()).trigger("inputChange")})),a.on("change",(function(){l.setValue(a.val())}))})),l(".colorpicker-input.colorpicker-element",t).each((function(e,t){$(t).colorpicker({container:$(t).find(".picker-container"),align:"left",format:void 0!==$(t).data("colorFormat")&&$(t).data("colorFormat")});const a=$(t).find("input");a.on("focusout",(function(){if(""==a.val())if(void 0!==$(t).data("default")){const e=$(t).data("default");$(t).colorpicker("setValue",e)}else $(t).find(".input-group-addon").css("background-color","")}))})),l(".color-gradient",t).each((function(e,t){$(t).find(".colorpicker-input.colorpicker-element").colorpicker({container:$(t).find(".picker-container"),align:"left",format:void 0!==$(t).data("colorFormat")&&$(t).data("colorFormat")});const a="#222",n="#eee",i=$(t).find("[name]:not(.color-gradient-hidden).element-property"),l=$(t).find(".color-gradient-hidden.element-property"),o=i.filter('[name="gradientType"]'),r=i.filter('[name="gradientAngle"]'),s=i.filter('[name="gradientColor1"]'),c=i.filter('[name="gradientColor2"]');if(""!=l.val()){const e=JSON.parse(l.val());o.val(e.type).trigger("change"),s.parents(".colorpicker-input").colorpicker("setValue",e.color1),c.parents(".colorpicker-input").colorpicker("setValue",e.color2),r.val(e.angle)}const d=function(){""==s.val()&&s.parents(".colorpicker-input").colorpicker("setValue",a),""==c.val()&&c.parents(".colorpicker-input").colorpicker("setValue",n),""==r.val()&&r.val(0),r.parent().toggle("linear"===o.val())};i.addClass("skip-save"),i.on("change",(function(){const e=o.val(),t=s.val(),i=c.val(),p=r.val(),u={type:e,color1:""!=t?t:a,color2:""!=i?i:n};"linear"===e&&(u.angle=""!=p?p:0),d(),l.val(JSON.stringify(u)).trigger("change")})),d()})),l(".dateControl.date:not(.datePickerHelper)",t).each((function(e,t){"Jalali"==calendarType?initDatePicker($(t),systemDateFormat,jsDateOnlyFormat,{altFieldFormatter:function(e){const t=moment.unix(e/1e3);return t.set("hour",0),t.set("minute",0),t.set("second",0),t.format(systemDateFormat)}}):initDatePicker($(t),systemDateFormat,jsDateOnlyFormat)})),l(".dateControl.dateTime:not(.datePickerHelper)",t).each((function(e,t){const a=dateFormat.includes("s"),n=!dateFormat.includes("A");"Jalali"==calendarType?initDatePicker($(t),systemDateFormat,jsDateFormat,{timePicker:{enabled:!0,second:{enabled:a}}}):initDatePicker($(t),systemDateFormat,jsDateFormat,{enableTime:!0,time_24hr:n,enableSeconds:a,altFormat:$(t).data("customFormat")?$(t).data("customFormat"):jsDateFormat})})),l(".dateControl.month:not(.datePickerHelper)",t).each((function(e,t){"Jalali"==calendarType?initDatePicker($(t),systemDateFormat,jsDateFormat,{format:$(t).data("customFormat")?$(t).data("customFormat"):"MMMM YYYY",viewMode:"month",dayPicker:{enabled:!1},altFieldFormatter:function(e){const t=moment.unix(e/1e3);return t.set("date",1),t.set("hour",0),t.set("minute",0),t.set("second",0),t.format(systemDateFormat)}}):initDatePicker($(t),systemDateFormat,jsDateFormat,{plugins:[new flatpickrMonthSelectPlugin({shorthand:!1,dateFormat:systemDateFormat,altFormat:$(t).data("customFormat")?$(t).data("customFormat"):"MMMM Y",parseDate:function(e,t){return moment(e,t,!0).toDate()},formatDate:function(e,t,a){return moment(e).format(t)}})]})})),l(".dateControl.time:not(.datePickerHelper)",t).each((function(e,t){const a=dateFormat.includes("s");"Jalali"==calendarType?initDatePicker($(t),systemTimeFormat,jsTimeFormat,{onlyTimePicker:!0,format:jsTimeFormat,timePicker:{second:{enabled:a}},altFieldFormatter:function(e){const t=moment.unix(e/1e3);return t.set("second",0),t.format(systemTimeFormat)}}):initDatePicker($(t),systemTimeFormat,jsTimeFormat,{enableTime:!0,noCalendar:!0,enableSeconds:a,time_24hr:!0,altFormat:$(t).data("customFormat")?$(t).data("customFormat"):jsTimeFormat})})),l(".rich-text",t).each((function(t,a){formHelpers.setupCKEditor(e,$(a).attr("id"),!0,null,!1,!0)})),l(".world-clock-control",t).each((function(e,t){const a=$(t).find(".clocksContainer"),n=$(t).find(".world-clock-value");function i(e){const t=[];$(e).find(".form-clock").each((function(e,a){""!=$(a).find(".localSelect select").val()&&t.push({clockTimezone:$(a).find(".localSelect select").val(),clockHighlight:$(a).find(".clockHighlight").is(":checked"),clockLabel:$(a).find(".clockLabel").val()})})),n.attr("value",JSON.stringify(t))}function l(e){$(e).find(".localSelect select.form-control").each((function(t,a){makeLocalSelect($(a),$(e).hasClass("modal")?$(e):$("body"))})),$(e).find('input[type="checkbox"]').on("click",(function(){i(e)})),$(e).find('input[type="text"], select').on("change",(function(){i(e)}))}!function(e){if(0==e.length)return;const i=formHelpers.getTemplate("worldClockTemplate"),o=n.attr("value")?JSON.parse(n.attr("value")):[];if(0==o.length){const e={title:"1",clockTimezone:"",timezones:timezones,buttonGlyph:"fa-plus"};$(i(e)).appendTo(a),l(t)}else{let e=0;$.each(o,(function(t,n){e++;const l={title:e,clockTimezone:n.clockTimezone,clockHighlight:n.clockHighlight,clockLabel:n.clockLabel,timezones:timezones,buttonGlyph:1==e?"fa-plus":"fa-minus"};a.append(i(l))})),l(t)}a.on("click","button",(function(e){if(e.preventDefault(),$(e.currentTarget).find("i").hasClass("fa-plus")){const e={title:a.find(".form-clock").length+1,clockTimezone:"",timezones:timezones,buttonGlyph:"fa-minus"};a.append(i(e)),l(t)}else $(e.currentTarget).closest(".form-clock").remove()}))}($(t)),l(t)})),l(".font-selector",t).each((function(e,t){const a=$(t).find("select");$.ajax({method:"GET",url:a.data("searchUrl"),success:function(e){void 0!==e.data&&e.data.length>0&&$.each(e.data,(function(e,t){a.data("value")===t.familyName?(a.append($('<option value="'+t.familyName+'" selected>'+t.name+"</option>")),a.trigger("change",[{skipSave:!0}])):a.append($('<option value="'+t.familyName+'">'+t.name+"</option>"))})),n&&i.makeFormReadOnly($(t))}})})),l(".snippet-selector",t).each((function(e,t){const l=$(t).find("select"),o=l.data("target"),r=$("[name="+o+"]"),s=l.data("mode"),c=function(e){formHelpers.setupSnippetsSelector(e,(function(e){const t=$(e.currentTarget).val();if(null==t||""==t||0==r.length)return;const n="["+t+"]";if(formHelpers.getCKEditorInstance("input_"+a+"_"+o))formHelpers.insertToCKEditor("input_"+a+"_"+o,n);else if(r.hasClass("code-input")){const e=window.codeEditors["input_"+a+"_"+o],t={identifier:{major:1,minor:1},range:e.getSelection(),text:n,forceMoveMarkers:!0};e.executeEdits("custom-code",[t]),r.trigger("change")}else{const e=r[0].selectionStart,t=r.val();r.val(t.substring(0,e)+n+t.substring(e)),r.trigger("change")}}))};if("dataSet"==s){const e=$(t).data("dependsOn"),a=$("[name="+e+"]").val();a&&$.ajax({url:urlsForApi.dataset.search.url,type:"GET",data:{dataSetId:a},success:function(e){const t=e.data[0];t&&t.columns&&t.columns.length>0?(l.find("option[value]").remove(),$.each(t.columns,(function(e,t){l.append($('<option data-snippet-type="'+t.dataType+'" value="'+t.heading+"|"+t.dataSetColumnId+'">'+t.heading+"</option>"))})),0==t.columns.length?l.parent().hide():c(l),n&&i.makeFormReadOnly(l.parent())):l.parent().hide()},error:function(){l.parent().append('{% trans "An unknown error has occurred. Please refresh" %}')}})}else if("dataType"==s){const e=urlsForApi.widget.getDataType.url.replace(":id",a);$.ajax({method:"GET",url:e,success:function(e){e&&e.fields&&e.fields.length>0?(l.find("option[value]").remove(),$.each(e.fields,(function(e,t){l.append($('<option data-snippet-type="'+t.type+'" value="'+t.id+'">'+t.title+"</option>"))})),0==e.fields.length?l.parent().hide():c(l),n&&i.makeFormReadOnly(l.parent())):l.parent().hide()},error:function(){l.parent().append('{% trans "An unknown error has occurred. Please refresh" %}')}})}else"options"==s?c(l):"media"==s&&function(e){e.data("searchUrl",urlsForApi.library.get.url),e.data("imageUrl",urlsForApi.library.download.url),formHelpers.setupMediaSelector(e,(function(e){const t=$(e.currentTarget).val();if(null==t||""==t)return;const n='<img alt="" src="'+urlsForApi.library.download.url.replace(":id",t)+'?preview=1" />';if(formHelpers.getCKEditorInstance("input_"+a+"_"+o))formHelpers.insertToCKEditor("input_"+a+"_"+o,n);else if(r.length>0){const e=r[0].selectionStart,t=r.val();r.val(t.substring(0,e)+n+t.substring(e))}}))}(l)})),l(".effect-selector",t).each((function(e,t){const a=$(t).find("select"),n=a.data("effects-type").split(" "),i=-1!=n.indexOf("all");if($.each([{effect:"none",group:"showAll"},{effect:"marqueeLeft",group:"showAll"},{effect:"marqueeRight",group:"showAll"},{effect:"marqueeUp",group:"showAll"},{effect:"marqueeDown",group:"showAll"},{effect:"noTransition",group:"showPaged"},{effect:"fade",group:"showPaged"},{effect:"fadeout",group:"showPaged"},{effect:"scrollHorz",group:"showPaged"},{effect:"scrollVert",group:"showPaged"},{effect:"flipHorz",group:"showPaged"},{effect:"flipVert",group:"showPaged"},{effect:"shuffle",group:"showPaged"},{effect:"tileSlide",group:"showPaged"},{effect:"tileBlind",group:"showPaged"}],(function(e,t){if(-1!=n.indexOf("noNone")&&"none"===t.effect)return;if(-1===n.indexOf("all")&&-1===n.indexOf(t.group))return;let l=a.find(`optgroup[data-type=${t.group}]`);i&&0==l.length&&(l=$(`<optgroup\n              label="${effectsTranslations[t.group]}"\n              data-type="${t.group}">\n            </optgroup>`),a.append(l)),(i?l:a).append($('<option value="'+t.effect+'" data-optgroup="'+t.group+'">'+effectsTranslations[t.effect]+"</option>"))})),void 0!==a.data("value")&&(a.val(a.data("value")),a.trigger("change",[{skipSave:!0}])),1===$(t).next().find('input[name="speed"]').length){let e=null;const n=$(t).next().find('input[name="speed"]'),i=function(e,t,a){const n=PlayerHelper.isMarquee(e),i=PlayerHelper.isMarquee(t);return n&&!i?1e3:!n&&i?1:0===String(a).length?i?1:1e3:a};a.on("select2:open",(function(t){e=t.currentTarget.value})),n.val(i(e,e,n.val())),a.on("select2:select",(function(t){const a=t.params.data.id;n.val(i(e,a,n.val()))}))}})),l(".menu-board-category-selector",t).each((function(t,a){const n=$(a),i=$(a).find("select"),l=n.data("depends-on"),o=$(e).find("[name="+l+"]").val();""!=o&&(i.data("search-url",i.data("search-url-base").replace(":id",o)),makePagedSelect(i))})),l(".select2-hidden-accessible",t).each((function(e,t){$(t).on("select2:open",(function(e){const t=$(e.target).data("select2").dropdown?.$search;setTimeout((function(){t&&t.get(0).focus()}),10)}))}));let o=0;l("input[data-role=panelTagsInput]",t).each((function(e,t){const a=$(t),n=a.data("autoCompleteUrl"),i=a.data("searchTermKey");if(void 0!==n&&""!==n){o++;const e=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,initialize:!1,remote:{url:n,prepare:function(e,t){return t.data={tag:e},void 0!==i&&""!==i&&(t.data[i]=e),t},transform:function(e){return $.map(e.data,(function(e){return 1===o?{tag:e.type}:e.type}))}}});e.initialize().done((function(){(o>1||a.prev().is(".bootstrap-tagsinput"))&&("function"==typeof a.tagsinput&&a.tagsinput("destroy"),o=0);const t={name:"tags",source:e.ttAdapter()};1===o&&(t.displayKey="tag",t.valueKey="tag"),a.tagsinput({typeaheadjs:[{hint:!0,highlight:!0},t]})})).fail((function(){console.info("Auto-complete for tag failed! Using default..."),a.tagsinput()}))}else a.tagsinput()})),t||$(e).find(".xibo-form-input[data-depends-on]").each((function(t,l){const o=$(l);let r=o.data("depends-on");if(o.data("depends-on-added"))return;o.attr("data-depends-on-added",!0);let s=null;if(-1!==r.indexOf("[")&&-1!==r.indexOf("]")){const e=r.split("[");r=e[0],s=e[1].replace("]","")}const c='[name="'+r+'"]';$(e).find(c).on("change",(function(t){let l=null;const r=$(t.currentTarget);if(r.is("select")){const e=r.find("option:selected");l=e.data("set")?e.data("set"):e.val()}else l=r.is('input[type="checkbox"]')?r.is(":checked"):r.val();null!==s&&null!==l&&(l=l.split(",")[s]),o.children('input[type="checkbox"]').length>0?o.children('input[type="checkbox"]').prop("checked",l):o.hasClass("colorpicker-input")?""===l?(o.find("input").val(""),o.find(".input-group-addon").css("background-color","")):null!=l&&Color(l).valid&&(o.find("input").colorpicker("setValue",l),o.find(".input-group-addon").css("background-color",l)):o.children('input[type="text"]').length>0?o.children('input[type="text"]').val(l):(o.data("dependsOnValue",l),i.initFields(e,o,a,n))}))}))},handleFormReplacements:function(e,t){const a=function(e){return e.replace(/\%(.*?)\%/g,(function(e,a){return a.split(".").reduce(((e,t)=>e[t]||`%${t}%`),t)}))};$(e).find(".xibo-form-input > [title], .xibo-form-btn[title]").each((function(e,t){const n=$(t),i=n.attr("title"),l=n.attr("data-original-title");i&&i.indexOf("%")>-1&&n.attr("title",a(i)),l&&l.indexOf("%")>-1&&n.attr("data-original-title",a(l))})),$(e).find(".xibo-form-input > *, .xibo-form-btn").each((function(e,t){const n=$(t),i=n.html();i&&i.indexOf("%")>-1&&n.html(a(i))}))},setConditions:function(e,t,a,n=!0){$(e).find(".xibo-form-input[data-visibility]").each((function(i,l){let o=$(l).data("visibility");o=JSON.parse(JSON.stringify(o).replace(/\$(.*?)\$/g,(function(e,a){return a.split(".").reduce(((e,t)=>e[t]),t)})));const r=function(t,a){let i="";const l=t.type,o=t.conditions,r=function(){let t;for(let a=0;a<o.length;a++){const i=o[a],r=`[name="${i.field}"]`,s=$(e).find(r),c=0!==s.length&&"checkbox"===s.attr("type")?s.is(":checked"):s.val(),d=checkCondition(i.type,i.value,c,n);a>0?"and"===l?t=t&&d:"or"===l&&(t=t||d):t=d}t?a.show():a.hide()};for(let e=0;e<t.conditions.length;e++)i+=`[name="${t.conditions[e].field}"]`,e<t.conditions.length-1&&(i+=",");String(i).length>0&&$(e).find(i).on("change",r),r()};if(Array.isArray(o))for(let e=0;e<o.length;e++)r(o[e],$(l));else(function(t){if(t?.field&&a)return 0!==$(e).find(`[name="${t.field}"]`).length;if(t.conditions.length>0&&a){for(let a=0;a<t.conditions.length;a++){const n=t.conditions[a].field;if(0===$(e).find(`[name="${n}"]`).length)return!1}return!0}})(o)&&r({conditions:[o],test:""},$(l))}))},checkForSpacingIssues:function(e){e.find("input[type=text]").each((function(e,t){formRenderDetectSpacingIssues(t),$(t).on("keyup",_.debounce((function(){formRenderDetectSpacingIssues(t)}),500))}))},makeFormReadOnly:function(e){e.find("input, select, textarea, button:not(.copyTextAreaButton)").attr("disabled","disabled"),e.find(".colorpicker-input i.input-group-addon").off("click"),e.find("button:not(.copyTextAreaButton), .date-clear-button").hide(),e.find(".bootstrap-switch").hide()},reloadRichTextFields:function(e){e.find(".rich-text").each((function(t,a){const n=$(a).attr("id"),i=$(a).parent();i.addClass("loading"),formHelpers.destroyCKEditor(n),formHelpers.setupCKEditor(e,n,!0,null,!1,!0),i.removeClass("loading")}))},createFallbackDataForm:function(e,t,a,n,i){const l=e.fields,o=function(e,t){e.find(".fallback-data-record-previews").empty(),l.forEach((a=>{if(t&&t[a.id]){const n=t[a.id],i=$(templates.forms.fallbackDataRecordPreview({trans:fallbackDataTrans,field:a,data:n}));e.find(".fallback-data-record-previews").append(i)}}))},r=function(e={}){const t=e.data,a=e.displayOrder,r=e.id,s=$(templates.forms.fallbackDataRecord({trans:fallbackDataTrans}));return null!=r&&s.data("recordId",r),null!=a&&s.data("displayOrder",a),l.forEach((e=>{const a=function(e,t){const a={...e},n=Math.floor(1e6*Math.random());let i;return null!=t&&(a.value=t),-1!=["datetime","date","time","month"].indexOf(a.type)&&(a.variant="datetime"===a.type?"dateTime":a.type,a.type="date"),"image"===a.type&&(a.type="mediaSelector",a.mediaSearchUrl=urlsForApi.library.get.url,a.initialValue=a.value,a.initialKey="mediaId"),"string"===a.type&&(a.type="text"),a.name=a.id,a.id=a.id+"_"+n,a.customClass="fallback-property",templates.forms.hasOwnProperty(a.type)&&(i=$(templates.forms[a.type](a))),i&&i.is('[data-is-required="true"]')&&i.find("label").append(`<span class="ml-1"\n            title=${fallbackDataTrans.requiredField}>*</span>`),i}(e,t&&t[e.id]);s.find(".fallback-data-record-fields").append(a)})),forms.initFields(s),o(s,t),$.isEmptyObject(e)&&s.addClass("editing"),s.find("button").on("click",(function(e){const t=$(e.currentTarget).data("action");"save-record"==t?function(e){const t={};let a=!1;if(l.forEach((n=>{const i=e.find('[name="'+n.id+'"]'),l=i.val(),o=i.parents(".fallback-property").is('[data-is-required="true"]');""==l&&o?a=!0:""!=l&&(t[n.id]=l)})),$.isEmptyObject(t))return void toastr.error(fallbackDataTrans.invalidRecordEmpty);if(a)return void toastr.error(fallbackDataTrans.invalidRecordRequired);const r=function(){o(e,t),i(),e.removeClass("editing")},s=e.data("recordId"),c=e.index();s?n.editFallbackDataRecord(s,t,c).then((e=>{e.success&&r()})):n.addFallbackData(t,c).then((t=>{t.success&&(e.data("recordId",t.id),r())}))}(s):"delete-record"==t?function(e){const t=e.data("recordId");t?n.deleteFallbackDataRecord(t).then((t=>{t.success&&(e.remove(),i())})):e.remove()}(s):"edit-record"==t&&s.addClass("editing")})),s};$(t).append(templates.forms.fallbackDataContent({data:e,trans:fallbackDataTrans,showFallback:n.getOptions().showFallback}));const s=$(t).find(".fallback-data-records");a&&(a.sort(((e,t)=>e.displayOrder-t.displayOrder)),a.forEach((e=>{s.append(r(e))})),XiboInitialise(".fallback-data-records")),$(t).find('[data-action="add-new-record"]').on("click",(function(){s.append(r()),XiboInitialise(".fallback-data-records")})),s.sortable({axis:"y",items:".fallback-data-record",containment:"parent",update:function(){let e=0;const t=[];s.find(".fallback-data-record").each(((a,n)=>{const i=$(n).data();i.recordId&&(t.push({dataId:i.recordId,displayOrder:e}),$(n).data("displayOrder",e),e++)})),n.saveFallbackDataOrder(t).then((e=>{e.success&&i()}))}})}};