var calendar,mymap,mymapmarker,events=[];$(document).ready((function(){var e=null;function t(e,t){var a=e.find('label[for="criteria_value[]"]');if(a.find("input, select").remove(),"dropdown"===t.inputType){var n=$('<select class="form-control" name="criteria_value[]"></select>');t.values.forEach((function(e){n.append(new Option(e.title,e.id))})),a.append(n)}else{var i;"text"!==t.inputType&&"number"!==t.inputType&&"date"!==t.inputType||(i=$('<input class="form-control" name="criteria_value[]" type="'+t.inputType+'" value="" />')),a.append(i)}}function a(e){var t=e.find('label[for="criteria_value[]"]'),a=$('<input class="form-control" name="criteria_value[]" type="text" value="" />');t.find("input, select").remove(),t.append(a)}if($("body").on("click",(function(e){$('[data-toggle="popover"]').each((function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||$(this).popover("hide")}))})),$("body").on("change",'#scheduleCriteriaFields select[name="criteria_type[]"]',(function(e){var n=$(e.target),i=n.closest(".form-group"),o=n.val(),r=$("#scheduleCriteriaFields").data("scheduleCriteria");r&&("custom"===o?(function(e){var t=e.find('label[for="criteria_metric[]"]'),a=$('<input class="form-control" name="criteria_metric[]" type="text" value="" />');t.find("input, select").remove(),t.append(a)}(i),a(i)):r&&function(e,n,i){var o=e.find('label[for="criteria_metric[]"]'),r=$('<select class="form-control" name="criteria_metric[]"></select>');if(n.types){var l=n.types.find((e=>e.id===i));if(l){var s=l.metrics;s.forEach((function(e){r.append(new Option(e.name,e.id))}));var d=r.val(),c=s.find((e=>e.id===d));c&&c.values?t(e,c.values):a(e)}}o.find("input, select").remove(),o.append(r)}(i,r,o))})),$("body").on("change",'#scheduleCriteriaFields select[name="criteria_metric[]"]',(function(e){var n=$(e.target),i=n.closest(".form-group"),o=n.val(),r=$("#scheduleCriteriaFields").data("scheduleCriteria"),l=i.find('select[name="criteria_type[]"]').val();if(r&&l){var s=r.types.find((e=>e.id===l));if(s){var d=s.metrics.find((e=>e.id===o));d&&d.values?t(i,d.values):a(i)}}})),$(".btn-group button[data-calendar-nav]").each((function(){var e=$(this);e.click((function(){calendar.navigate(e.data("calendar-nav"))}))})),$(".btn-group button[data-calendar-view]").each((function(){var e=$(this);e.click((function(){calendar.view(e.data("calendar-view")),$("#range").val(e.data("calendar-view"))}))})),$('a[data-toggle="tab"].schedule-nav').on("shown.bs.tab",(function(e){"#calendar-view"===$(e.target).attr("href")?$("#range").trigger("change"):"agenda"===$("#range").val()&&$("#range").val("day").trigger("change")})),$("#Calendar").length>0){var n=$("#CalendarContainer").data();const t=function(){if(null!=calendar){let e=moment(moment($("#fromDt").val()).format(systemDateFormat));e.isValid()&&calendar.navigate("date",e)}},a=function(){calendar.navigate("date",moment($("#dateInput input[data-input]").val()))};$("#range").on("change",(function(){if(null!=calendar){let e=$("#range").val(),a=e.includes("last");"custom"===e?$("#fromDt, #toDt").on("change",(function(){t();let e=moment(moment($("#fromDt").val()).startOf("day").format(systemDateFormat)),a=moment(moment($("#toDt").val()).startOf("day").format(systemDateFormat)).diff(e,"days");a<1?"agenda"===calendar.options.view?calendar.view("agenda"):calendar.view("day"):a>=1&&a<=7?calendar.view("week"):a>7&&a<=31?calendar.view("month"):calendar.view("year")})):(e=a?e.replace("last",""):e,calendar.view(e)),"agenda"===e&&$("#calendar-tab").trigger("click")}updateRangeFilter($("#range"),$("#fromDt"),$("#toDt"),t)})),updateRangeFilter($("#range"),$("#fromDt"),$("#toDt"));var i={};"Jalali"==calendarType?i={autoClose:!0,altField:"#dateInputLink",altFieldFormatter:function(e){var t=moment.unix(e/1e3);return t.set("hour",0),t.set("minute",0),t.set("second",0),t.format(jsDateFormat)},onSelect:function(){},onHide:function(){$("#dateInput").trigger("change"),$("#dateInputLink").trigger("change")}}:"Gregorian"==calendarType&&(i={wrap:!0,altFormat:jsDateOnlyFormat}),initDatePicker($("#dateInput"),systemDateFormat,jsDateOnlyFormat,i,a,!1);var o=$(".cal-event-location-map #geoFilterAgendaMap");$("#getLocation").off().click((function(){var e=$(this);e.prop("disabled",!0),navigator.geolocation.getCurrentPosition((function(t){$("#geoLatitude").val(t.coords.latitude).change(),$("#geoLongitude").val(t.coords.longitude).change(),e.prop("disabled",!1),generateFilterGeoMap()}),(function(t){console.warn("ERROR("+t.code+"): "+t.message),e.prop("disabled",!1)}),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})})),$("#toggleMap").off().click((function(){o.toggleClass("d-none"),o.hasClass("d-none")||generateFilterGeoMap()})),$("#clearLocation").off().click((function(){$("#geoLatitude").val("").change(),$("#geoLongitude").val("").change(),o.hasClass("d-none")||generateFilterGeoMap()})),$("#geoLatitude, #geoLongitude").off().change(_.debounce((function(){calendar.view()}),400));var r={time_start:"00:00",time_end:"00:00",events_source:function(){return events},view:"month",tmpl_path:function(e){return"calendar-template-"+e},tmpl_cache:!0,onBeforeEventsLoad:function(t){var a=$("#CalendarContainer").data();const n=$("#calendar-error-message");var i=$("#showAll").is(":checked");if($("#DisplayList, #DisplayGroupList").prop("disabled",i),"agenda"!==this.options.view){$(".cal-event-agenda-filter, .xibo-agenda-calendar-controls, #btn-month-view").hide(),$("#btn-agenda-view").show(),$(".non-agenda-filter").find("input, select").prop("disabled",!1);let i=$('select[name="displayGroupIds[]"').serialize(),r=$('select[name="displaySpecificGroupIds[]"').serialize(),l=$("#campaignIdFilter").serialize(),s=$("#eventTypeId").serialize(),d=$("#geoAware").serialize(),c=$("#recurring").serialize(),p=$("#name").serialize(),u="useRegexForName="+$("#useRegexForName").is("checked"),m=$("#logicalOperatorName").serialize();i||l||r?n.hide():n.show();var o=a.eventSource;o+="?"+l+"&"+s+"&"+d+"&"+c+"&"+p+"&"+u+"&"+m,i||r||""===l?""===i&&""===r||(o+="&"+i+"&"+r):o+="&displayGroupIds[]=-1",events=[];let f={from:moment(this.options.position.start.getTime()).format(systemDateFormat),to:moment(this.options.position.end.getTime()).format(systemDateFormat)};e&&e.abort(),$("#calendar-progress").addClass("show"),e=$.getJSON(o,f).done((function(e){events=e.result,null!=t&&t(),calendar._render(),$('[data-toggle="popover"]').popover({trigger:"manual",html:!0,placement:"bottom",content:function(){return $(this).html()}}).on("mouseenter",(function(){var e=this;$('[data-toggle="popover"]').not(this).popover("hide"),$(this).popover("show"),$(".popover").off("mouseleave").on("mouseleave",(function(){$(e).popover("hide")}))})).on("shown.bs.popover",(function(){var e=$(this),t=e.attr("aria-describedby");$("#"+t+" a").click((function(t){t.preventDefault(),XiboFormRender($(this)),e.popover("hide")}))})),$("#calendar-progress").removeClass("show")})).fail((function(e){$("#calendar-progress").removeClass("show"),null!=t&&t(),calendar._render(),"abort"!=e.statusText&&(toastr.error(translations.failure),console.error(e))}))}else{$(".cal-event-agenda-filter, .xibo-agenda-calendar-controls, #btn-month-view").show(),$("#btn-agenda-view").hide(),$(".non-agenda-filter").find("input, select").prop("disabled",!0),n.hide();for(var r=$("#timePicker"),l=moment().tz?moment().tz(timezone):moment(),s=[],d=[],c=[],p=0;p<=1440;p+=120){var u=1440===p?1439:p;s.push(u),d.push(l.clone().startOf("day").add(u,"minutes").format(jsTimeFormat)),c.push(p/1440*100)}r.slider({value:60*l.hour()+l.minute(),tooltip:"always",ticks:s,ticks_labels:d,ticks_positions:c,formatter:function(e){return moment().startOf("day").minute(e).format(jsTimeFormat)}}).off("slideStop").on("slideStop",(function(e){calendar.view()})),$(".time-picker-step-btn").off().on("click",(function(){r.slider("setValue",r.slider("getValue")+$(this).data("step")),calendar.view()}));var m=$(".cal-context").data().selectedTab,f=[],v=!1;i||($("#DisplayList, #DisplayGroupList").prop("disabled",!1),$('select[name="displayGroupIds[]"] option, select[name="displaySpecificGroupIds[]"] option').each((function(){var e=$(this);if(-1==e.val()&&e.is(":selected"))return v=!0,!0;(e.is(":selected")||v)&&(f.push({id:e.val(),name:e.html(),isDisplaySpecific:e.attr("type")}),void 0===m&&(m=e.val()))}))),f.sort((function(e,t){var a=e.name.toLowerCase(),n=t.name.toLowerCase();return a<n?-1:a>n?1:0})),o=a.agendaLink.replace(":id",m);var g=moment(this.options.position.start.getTime()/1e3,"X"),y=$("#timePickerSlider").length?$("#timePicker").slider("getValue"):0,h=moment(60*y,"X"),b={date:moment(g+h).format(systemDateFormat)};jQuery.isEmptyObject(events.results)&&((events=[]).results={}),events.displayGroupList=f,events.selectedDisplayGroup=m,events.errorMessage="",1==calendar.options.clearCache&&(events.results={}),e&&e.abort(),i?(events.errorMessage="all_displays_selected",null!=t&&t(),calendar._render()):null==f||Array.isArray(f)&&0==f.length?(events.errorMessage="display_not_selected",null!=t&&t(),calendar._render()):jQuery.isEmptyObject(events.results[m])||events.results[m].request_date!=b.date||events.results[m].geoLatitude!=$("#geoLatitude").val()||events.results[m].geoLongitude!=$("#geoLongitude").val()?($("#calendar-progress").addClass("show"),e=$.getJSON(o,b).done((function(e){var a=!0;!jQuery.isEmptyObject(e.data)&&null!=e.data.events&&e.data.events.length>0&&(events.results[String(m)]=e.data,events.results[String(m)].request_date=b.date,a=!1,null!=$("#geoLatitude").val()&&""!=$("#geoLatitude").val()&&null!=$("#geoLongitude").val()&&""!=$("#geoLongitude").val()&&(events.results[String(m)].geoLatitude=$("#geoLatitude").val(),events.results[String(m)].geoLongitude=$("#geoLongitude").val(),events.results[String(m)].events=filterEventsByLocation(events.results[String(m)].events),a=e.data.events.length<=0)),a&&(events.results[String(m)]={},events.errorMessage="no_events"),null!=t&&t(),calendar._render(),$("#calendar-progress").removeClass("show")})).fail((function(e){null!=t&&t(),"abort"!=e.statusText&&(events.errorMessage="request_failed"),calendar._render(),$("#calendar-progress").removeClass("show")}))):(null!=t&&t(),calendar._render())}},onAfterEventsLoad:function(e){"agenda"==this.options.view&&$(".agenda-panel").ready((function(){$(".agenda-table-layouts").DataTable({searching:!1})}))},onAfterViewLoad:function(e){null!=this.options.position.start&&""!=this.options.position.start&&updateDatePicker($("#dateInput"),moment.unix(this.options.position.start.getTime()/1e3).format(systemDateFormat),systemDateFormat),"function"==typeof this.getTitle&&$("h1.page-header").text(this.getTitle()),$(".btn-group button").removeClass("active"),$('button[data-calendar-view="'+e+'"]').addClass("active")},language:calendarLanguage};r.type=n.calendarType,calendar=$("#Calendar").calendar(r),$(".cal-context").on("click",'a[data-toggle="tab"]',(function(e){$(".cal-context").data().selectedTab=$(this).data("id"),calendar.view()})),$(".cal-context").on("click","tbody tr",(function(e){var t=$(this),a=t.hasClass("selected");$(".cal-event-breadcrumb-trail").hide(),$(".cal-context tbody tr").removeClass("selected"),$(".cal-context tbody tr").removeClass("selected-linked"),a||("layouts"==t.closest("table").data("type")&&($(".cal-event-breadcrumb-trail").show(),$(".cal-event-breadcrumb-trail #content").html(""),$(".cal-event-breadcrumb-trail #content").append(calendar._breadcrumbTrail(t.data("elemId"),events,t.data("eventId"))),createMiniLayoutPreview(layoutPreviewUrl.replace(":id",t.data("elemId"))),XiboInitialise("")),agendaSelectLinkedElements(t.closest("table").data("type"),t.data("elemId"),events,t.data("eventId")))}))}}));var setupScheduleForm=function(e){var t=$("#isGeoAware"),a=t.is(":checked");let n=e.find("form");configureCriteriaFields(e),a&&$(".nav-tabs a").on("shown.bs.tab",(function(e){"Geo Location"===$(e.target).text()&&($("#geoScheduleMap").removeClass("d-none"),generateGeoMap(n))})),t.change((function(){(a=$("#isGeoAware").is(":checked"))?($("#geoScheduleMap").removeClass("d-none"),generateGeoMap(n)):$("#geoScheduleMap").addClass("d-none")}));var i=$("#shareOfVoice"),o=$("#shareOfVoicePercentage");i.on("change paste keyup",(function(){r(i.val())})),o.on("change paste keyup",(function(){var e,t=o.val();e=Math.round(3600*t/100),i.val(e)}));var r=function(e){var t;t=100*e/3600,o.val(t.toFixed(2))};r(i.val()),setupSelectForSchedule(e),$('select[name="recurrenceRepeatsOn[]"]',e).select2({width:"100%"}),processScheduleFormElements($("#recurrenceType",e)),processScheduleFormElements($("#eventTypeId",e)),processScheduleFormElements($("#campaignId",e)),processScheduleFormElements($("#actionType",e)),processScheduleFormElements($("#relativeTime",e)),$("#recurrenceType, #eventTypeId, #dayPartId, #campaignId, #actionType, #fullScreenCampaignId, #relativeTime, #syncTimezone",e).on("change",(function(){processScheduleFormElements($(this))}));var l=_.debounce((function(){scheduleEvaluateRelativeDateTime(n)}),500);n.find("#hours").on("change keyup",l),n.find("#minutes").on("change keyup",l),n.find("#seconds").on("change keyup",l),$('a[data-toggle="tab"]',e).on("shown.bs.tab",(function(t){var a,n=$(e).find("input[name=fromDt]"),i=null===n.val()||""===n.val()?moment():moment(n.val()),o=$(e).find("select[name=recurrenceMonthlyRepeatsOn]"),r=$('<option value="0">'+o.data("transDay").replace("[DAY]",i.format("Do"))+"</option>"),l=$('<option value="1">'+o.data("transWeekday").replace("[POSITION]",(a=Math.ceil(i.date()/7),a+(["st","nd","rd"][((a+90)%100-10)%10-1]||"th"))).replace("[WEEKDAY]",i.format("dddd"))+"</option>");o.find("option").remove().end().append(r).append(l).val(o.data("value"))})),$("#scheduleAddForm, #scheduleEditForm, #scheduleDeleteForm, #scheduleRecurrenceDeleteForm").submit((function(e){e.preventDefault();const t=$(this),a=t.serializeObject();processCriteriaFields(t,a),$.ajax({type:t.attr("method"),url:t.attr("action"),data:a,cache:!1,dataType:"json",success:function(e,a,n){XiboSubmitResponse(e,t),e.success&&void 0!==calendar&&(calendar.options.clearCache=!0,calendar.view())}})})),$(e).find('[data-toggle="popover"]').popover();var s=$(e).find("#scheduleEditForm, #scheduleEditSyncForm");if(s.length>0){var d=$("<button>").addClass("btn btn-info").attr("id","scheduleDuplateButton").html(translations.duplicate).on("click",(function(){duplicateScheduledEvent(s)}));$(e).find(".modal-footer").prepend(d),s.find("#instanceStartDate").html(moment(s.data().eventStart,"X").format(jsDateFormat)),s.find("#instanceEndDate").html(moment(s.data().eventEnd,"X").format(jsDateFormat)),d=$("<button>").addClass("btn btn-primary").attr("id","scheduleRecurringDeleteButton").html(translations.deleteRecurring).on("click",(function(){deleteRecurringScheduledEvent(s.data("eventId"),s.data("eventStart"),s.data("eventEnd"))})),$(e).find("#recurringInfo").prepend(d)}configReminderFields($(e))},deleteRecurringScheduledEvent=function(e,t,a){var n=scheduleRecurrenceDeleteUrl.replace(":id",e);XiboSwapDialog(n,{eventStart:t,eventEnd:a})},beforeSubmitScheduleForm=function(e){e.find('[name="reminder_isEmail[]"]').each((function(e){$(this).parent().find('[type="hidden"]').val($(this).is(":checked")?"1":"0")})),$('[data-toggle="popover"]').popover(),e.submit()},fullscreenBeforeSubmit=function(e,t,a=!0){const n=e.find("#eventTypeId").val();let i={id:7==n?e.find("#mediaId").val():e.find("#playlistId").val(),type:7==n?"media":"playlist",layoutDuration:7==n?e.find("#layoutDuration").val():null,resolutionId:e.find("#resolutionId").select2("data").length>0?e.find("#resolutionId").select2("data")[0].id:null,backgroundColor:e.find("#backgroundColor").val()};$.ajax({type:"POST",url:e.data().fullScreenUrl,cache:!1,dataType:"json",data:i}).then((i=>{if(i.success||SystemMessageInline(""===i.message?translations.failure:i.message,e.closest(".modal")),a)if(7==n){const t=$("#fullScreenControl_media");t.text(t.data("hasLayout")),$("#fullScreen-media").val(e.find("#mediaId").select2("data")[0].text),$("#fullScreen-mediaId").val(e.find("#mediaId").select2("data")[0].id)}else if(8==n){const t=$("#fullScreenControl_playlist");t.text(t.data("hasLayout")),$("#fullScreen-playlist").val(e.find("#playlistId").select2("data")[0].text),$("#fullScreen-playlistId").val(e.find("#playlistId").select2("data")[0].id)}$("#fullScreenCampaignId").val(i.data.campaignId).trigger("change"),"function"==typeof t&&t(e),$("#full-screen-schedule-modal").modal("hide")}),(e=>{SystemMessage(e.responseText,!1)}))},configReminderFields=function(e){var t=e.find("#reminderFields");if(0!=t.length){var a=Handlebars.compile($("#reminderEventTemplate").html());if(0==t.data().reminders.length)t.append(a({title:0,buttonGlyph:"fa-plus"}));else{var n=0;$.each(t.data().reminders,(function(e,i){n++;var o={scheduleReminderId:i.scheduleReminderId,value:i.value,type:i.type,option:i.option,isEmail:i.isEmail,title:n,buttonGlyph:1==n?"fa-plus":"fa-minus"};t.append(a(o))}))}t.on("click","button",(function(e){if(e.preventDefault(),$(this).find("i").hasClass("fa-plus")){var n={title:t.find(".form-group").length+1,buttonGlyph:"fa-minus"};t.append(a(n))}else $(this).closest(".form-group").remove()}))}},processScheduleFormElements=function(e){var t=e.val();let a=$("#relativeTime").is(":checked");switch(e.attr("id")){case"recurrenceType":var n=""==t?"none":"",i="Week"!=t?"none":"",o="Month"!==t?"none":"";$(".repeat-control-group").css("display",n),$(".repeat-weekly-control-group").css("display",i),$(".repeat-monthly-control-group").css("display",o),$("#recurrenceDetail").parent().find(".input-group-addon").html(e.val());break;case"eventTypeId":var r=2==t||6==t||7==t||8==t||10==t?"none":"",l=2==t||a?"none":"",s=a&&2!=t?"none":"",d=2==t?"none":"",c=2==t?"":"none",p=4==t?"":"none",u=6==t?"":"none",m=2==t||6==t||10==t?"none":"",f=7==t?"":"none",v=8==t?"":"none",g=7==t||8==t?"":"none",y=2!=t&&a?"":"none",h=2==t?"none":"",b=10==t?"":"none";if($(".layout-control").css("display",r),$(".endtime-control").css("display",l),$(".starttime-control").css("display",s),$(".day-part-control").css("display",d),$(".command-control").css("display",c),$(".interrupt-control").css("display",p),$(".action-control").css("display",u),$(".max-plays-control").css("display",m),$(".media-control").css("display",f),$(".playlist-control").css("display",v),$(".media-playlist-control").css("display",g),$(".relative-time-control").css("display",y),$(".relative-time-checkbox").css("display",h),$(".data-connector-control").css("display",b),6===t&&$(".displayOrder-control").css("display","none"),2==t){var L=$("#dayPartId"),S=0;L.find("option").each((function(e,t){1===$(t).data("isCustom")&&(S=$(t).val())})),L.val(S),(T=$(".starttime-control")).find("input[name=fromDt_Link2]").show(),T.find(".help-block").html(T.closest("form").data().daypartMessage),$("li.repeats").css("display","block"),$("li.reminders").css("display","block")}processScheduleFormElements($("#dayPartId"));var w=e.closest("form").find("#campaignId"),k=$(".layout-control"),D=-1;"1"===t||"3"===t||"4"===t?(D=1,k.children("label").text(w.data("transLayout")),k.children("div").children("small.form-text.text-muted").text(w.data("transLayoutHelpText"))):(D=0,k.children("label").text(w.data("transCampaign")),k.children("div").children("small.form-text.text-muted").text(w.data("transCampaignHelpText"))),w.data("searchIsLayoutSpecific",D);break;case"dayPartId":if(!e.is(":visible"))return;var C=e.find("option[value="+t+"]").data(),I=(l=0===C.isCustom||a?"none":"",s=1===C.isAlways||a?"none":"",1===C.isAlways?"none":""),F=1===C.isAlways?"none":"",T=(y=0!==C.isCustom&&a?"":"none",h=0===C.isCustom?"none":"",$(".starttime-control")),_=$(".endtime-control"),x=$("li.repeats"),E=$("li.reminders"),G=$(".relative-time-control"),O=$(".relative-time-checkbox");T.css("display",s),_.css("display",l),x.css("display",I),E.css("display",F),G.css("display",y),O.css("display",h),0===C.isAlways&&0===C.isCustom?(T.find("input[name=fromDt_Link2]").hide(),T.find("small.text-muted").html(T.closest("form").data().notDaypartMessage)):(T.find("input[name=fromDt_Link2]").show(),T.find("small.text-muted").html(T.closest("form").data().daypartMessage)),0===C.isAlways?(T.find("input[name=fromDt]").prop("disabled",!1),_.find("input[name=toDt]").prop("disabled",!1)):(T.find("input[name=fromDt]").prop("disabled",!0),_.find("input[name=toDt]").prop("disabled",!0));break;case"campaignId":case"fullScreenCampaignId":var M=$("#previewButton");null===t||""===t||0===t?M.closest(".preview-button-container").hide():(M.closest(".preview-button-container").show(),M.attr("href",M.data().url.replace(":id",t)));break;case"actionType":if(!e.is(":visible"))return;var j="navLayout"==t&&e.is(":visible")?"":"none";c="command"==t?"":"none",$(".layout-code-control").css("display",j),$(".command-control").css("display",c);break;case"relativeTime":if(!e.is(":visible"))return;var P=$(e).is(":checked")?"none":"",R=$(e).is(":checked")||2==$("#eventTypeId").val()?"none":"";y=$(e).is(":checked")?"":"none",T=$(".starttime-control"),_=$(".endtime-control"),G=$(".relative-time-control"),dateFormat.indexOf("s")<=-1&&$(".schedule-now-seconds-field").remove(),$(e).is(":checked")&&scheduleEvaluateRelativeDateTime($(e).closest("form")),T.css("display",P),_.css("display",R),G.css("display",y);break;case"syncTimezone":$("#relativeTime").is(":checked")&&scheduleEvaluateRelativeDateTime($(e).closest("form"))}},duplicateScheduledEvent=function(e){e.attr("action",e.data().addUrl).attr("method","post"),$("#scheduleDuplateButton").remove(),toastr.info(e.data().duplicatedMessage)},scheduleEvaluateRelativeDateTime=function(e){var t=e.find("#hours").val(),a=e.find("#minutes").val(),n=e.find("#seconds").val(),i=moment(),o=moment(),r=$(".scheduleNowMessage");let l=e.find("#syncTimezone"),s="";""!=t&&o.add(t,"hours"),""!=a&&o.add(a,"minutes"),""!=n&&o.add(n,"seconds"),""==t&&""==a&&""==n?(r.html("").addClass("d-none"),updateDatePicker(e.find("#fromDt"),""),updateDatePicker(e.find("#toDt"),"")):(s=l.is(":checked")?"templateSync":"templateNoSync",r.html(r.data(s).replace("[fromDt]",i.format(jsDateFormat)).replace("[toDt]",o.format(jsDateFormat))).removeClass("d-none"),updateDatePicker(e.find("#fromDt"),i.format(systemDateFormat),systemDateFormat,!0),updateDatePicker(e.find("#toDt"),o.format(systemDateFormat),systemDateFormat,!0))},agendaSelectLinkedElements=function(e,t,a,n){var i=[],o={layouts:"selected-linked",overlays:"selected-linked",displaygroups:"selected-linked",campaigns:"selected-linked"};results=a.results[a.selectedDisplayGroup];for(var r=results.events,l=0;l<r.length;l++)"layouts"!=e&&"overlays"!=e||r[l].layoutId!=t||r[l].eventId!=n?"displaygroups"==e&&r[l].displayGroupId==t?(i.push(r[l]),o.displaygroups="selected"):"campaigns"==e&&r[l].campaignId==t&&(i.push(r[l]),o.campaigns="selected"):(i.push(r[l]),o[e]="selected");for(l=0;l<i.length;l++)$('table[data-type="layouts"] tr[data-elem-id~="'+i[l].layoutId+'"][data-event-id~="'+i[l].eventId+'"]').addClass(o.layouts),$('table[data-type="displaygroups"] tr[data-elem-id~="'+i[l].displayGroupId+'"]').addClass(o.displaygroups),$('table[data-type="campaigns"] tr[data-elem-id~="'+i[l].campaignId+'"]').addClass(o.campaigns)},generateGeoMap=function(e){null!=mymap&&mymap.remove();var t=$("#"+e.attr("id")).data().defaultLat,a=$("#"+e.attr("id")).data().defaultLong;mymap=L.map("geoScheduleMap").setView([t,a],13),L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}).addTo(mymap);var n=new L.FeatureGroup;mymap.addLayer(n);var i=new L.Control.Draw({position:"topright",draw:{polyline:!1,circle:!1,marker:!1,circlemarker:!1},edit:{featureGroup:n}}),o=new L.Control.Draw({position:"topright",draw:!1,edit:{featureGroup:n}});mymap.addControl(i);var r=new L.Control.Search({url:"https://nominatim.openstreetmap.org/search?format=json&q={s}",jsonpParam:"json_callback",propertyName:"display_name",propertyLoc:["lat","lon"],marker:L.circleMarker([0,0],{radius:30}),autoCollapse:!0,autoType:!1,minLength:2,hideMarkerOnCollapse:!0,firstTipSubmit:!0});mymap.addControl(r);var l="",s=null;if(mymap.on("draw:created",(function(e){s=e.layer,n.addLayer(s),l=s.toGeoJSON(),$("#geoLocation").val(JSON.stringify(l)),mymap.removeControl(i),mymap.addControl(o)})),mymap.on("draw:edited",(function(e){e.layers.eachLayer((function(e){l=e.toGeoJSON(),$("#geoLocation").val(JSON.stringify(l))}))})),mymap.on("draw:deleted",(function(e){e.layers.eachLayer((function(e){$("#geoLocation").val(""),n.removeLayer(e)})),0===n.getLayers().length&&(mymap.removeControl(o),mymap.addControl(i))})),null!=$("#geoLocation").val()&&""!==$("#geoLocation").val()){var d=JSON.parse($("#geoLocation").val());L.geoJSON(d,{onEachFeature:function(e,t){n.addLayer(t),mymap.fitBounds(t.getBounds())}}),mymap.removeControl(i),mymap.addControl(o)}},generateFilterGeoMap=function(){null!=mymap&&mymap.remove();var e=$("#geoLatitude").val(),t=$("#geoLongitude").val();null!=e&&""!=e&&null!=t&&""!=t||(e=$(".cal-event-location-map").data("defaultLat"),t=$(".cal-event-location-map").data("defaultLong")),mymap=L.map("geoFilterAgendaMap").setView([e,t],13),L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}).addTo(mymap);var a=new L.Control.Search({url:"https://nominatim.openstreetmap.org/search?format=json&q={s}",jsonpParam:"json_callback",propertyName:"display_name",propertyLoc:["lat","lon"],marker:L.circleMarker([0,0],{radius:30}),autoCollapse:!0,autoType:!1,minLength:2,hideMarkerOnCollapse:!0});mymap.addControl(a);var n=function(e,t){null!=mymapmarker&&mymap.removeLayer(mymapmarker),mymapmarker=L.marker([e,t],mymap).addTo(mymap)};mymap.on("click",(function(e){$("#geoLatitude").val(e.latlng.lat).change(),$("#geoLongitude").val(e.latlng.lng).change(),n(e.latlng.lat,e.latlng.lng)})),null!=$("#geoLatitude").val()&&""!=$("#geoLatitude").val()&&null!=$("#geoLongitude").val()&&""!=$("#geoLongitude").val()&&n($("#geoLatitude").val(),$("#geoLongitude").val())},filterEventsByLocation=function(e){for(var t=[],a=0;a<e.length;a++){var n=e[a];if(""!=n.geoLocation){var i=JSON.parse(n.geoLocation),o=[$("#geoLongitude").val(),$("#geoLatitude").val()],r=L.geoJSON(i);leafletPip.pointInLayer(o,r).length>0&&t.push(n)}else t.push(n)}return t},setupSelectForSchedule=function(e){var t=$("#campaignId",e);t.select2({dropdownParent:$(e).find("form"),ajax:{url:t.data("searchUrl"),dataType:"json",delay:250,data:function(e){var a={isLayoutSpecific:t.data("searchIsLayoutSpecific"),retired:0,totalDuration:0,name:e.term,start:0,length:10,columns:[{data:"isLayoutSpecific"},{data:"campaign"}],order:[{column:0,dir:"asc"},{column:1,dir:"asc"}]};return null!=e.page&&(a.start=10*(e.page-1)),a},processResults:function(e,t){var a=[];$.each(e.data,(function(e,t){a.push({id:t.campaignId,text:t.campaign})}));var n=t.page||1;return{results:a,pagination:{more:10*(n=n>1?n-1:n)<e.recordsTotal}}}}}),t.on("select2:open",(function(e){setTimeout((function(){$(e.target).data("select2").dropdown.$search.get(0).focus()}),10)}));var a=$('select[name="displayGroupIds[]"]',e);if(a.select2({dropdownParent:$(e).find("form"),ajax:{url:a.data("searchUrl"),dataType:"json",delay:250,data:function(e){var t={isDisplaySpecific:-1,forSchedule:1,displayGroup:e.term,start:0,length:10,columns:[{data:"isDisplaySpecific"},{data:"displayGroup"}],order:[{column:0,dir:"asc"},{column:1,dir:"asc"}]};return null!=e.page&&(t.start=10*(e.page-1)),t},processResults:function(e,t){var n=[],i=[];$.each(e.data,(function(e,t){1===t.isDisplaySpecific?i.push({id:t.displayGroupId,text:t.displayGroup}):n.push({id:t.displayGroupId,text:t.displayGroup})}));var o=t.page||1;return o=o>1?o-1:o,{results:[{text:n.length>0?a.data("transGroups"):null,children:n},{text:i.length>0?a.data("transDisplay"):null,children:i}],pagination:{more:10*o<e.recordsTotal}}}}}),-1==[void 0,""].indexOf(a.data("initialKey"))&&$(e).find("form").data("setDisplaysFromGridFilters")){let e=$("#DisplayList").val()??[],t=$("#DisplayGroupList").val()??[],o=e.concat(t);a.data("initial-value",o);var n=a.data("initialValue"),i={};i[a.data("initialKey")]=n,i.isDisplaySpecific=-1,i.forSchedule=1,$.ajax({url:a.data("searchUrl"),type:"GET",data:i}).then((function(e){e.data.forEach((e=>{var t=new Option(e[a.data("textProperty")],e[a.data("idProperty")],!0,!0);a.append(t)})),a.trigger("change",[{skipSave:!0}]),a.trigger({type:"select2:select",params:{data:e}})}))}$("#mediaId, #playlistId",e).on("select2:select",(function(e){let t=!1;void 0!==e.params.data.data?t=e.params.data.data[0].hasFullScreenLayout:void 0!==e.params.data.hasFullScreenLayout&&(t=e.params.data.hasFullScreenLayout),t?$(".no-full-screen-layout").css("display","none"):"mediaId"===$(this).attr("id")?$(".no-full-screen-layout").css("display",""):$(".no-full-screen-layout.media-playlist-control").css("display","")})),$("#syncGroupId",e).on("select2:select",(function(t){let a=e.find("form").data().eventSyncGroupId==$(this).select2("data")[0].id?e.find("form").data().eventId:null;$.ajax({type:"GET",url:e.find("form").data().fetchSyncDisplays.replace(":id",$(this).select2("data")[0].id),cache:!1,dataType:"json",data:{eventId:a}}).then((t=>{t.success||SystemMessageInline(""===t.message?translations.failure:t.message,form.closest(".modal")),$("#content-selector").removeClass("d-none");let a=Handlebars.compile($("#syncEventContentSelector").html());e.find("#contentSelectorTable tbody").html("").append(a(t.data));let n=e.find("form").attr("id");e.find(".pagedSelect select.form-control.syncContentSelect").each((function(){makePagedSelect($(this),"#"+n)})),e.find(".pagedSelect select.form-control.syncContentSelect").on("select2:select",(function(){$(this).data().displayId===$(this).data().leadDisplayId&&$("#setMirrorContent").removeClass("d-none")})),e.find("#setMirrorContent").on("click",(function(){let t=$(this).data().displayId,a=$("#layoutId_"+t).select2("data")[0].id;e.find(".pagedSelect select.form-control.syncContentSelect").not("#layout_"+t).each((function(){$(this).data().initialValue=a,makePagedSelect($(this),"#"+n)}))}))}),(e=>{SystemMessage(e.responseText,!1)}))}))};const configureCriteriaFields=function(e){const t=e.find("#scheduleCriteriaFields");if(t.length<=0)return;const a=t.data("scheduleCriteria"),n=a?a.types:[],i=Handlebars.compile($("#templateScheduleCriteriaFields").html()),o=function(e){n&&n.length>0&&n.forEach((t=>{e.append(new Option(t.name,t.id))}))},r=t.data("criteria");if(r&&r.length>0){let e=0;$.each(r,(function(a,r){e++,r.isAdd=1===e,r.i=e;const l=$(i(r));t.append(l);const s=l.find('select[name="criteria_type[]"]');o(s),s.val(r.type),function(e,t,a,i){const o=e.find('label[for="criteria_metric[]"]');let r;if("custom"===t)r=$('<input class="form-control" name="criteria_metric[]" type="text" value="" />');else{r=$('<select class="form-control" name="criteria_metric[]"></select>');const e=n?n.find((e=>e.id===t)):null;e?e.metrics.forEach((e=>{r.append(new Option(e.name,e.id))})):r=$('<input class="form-control" name="criteria_metric[]" type="text" value="'+a+'" />')}if(o.find("input, select").remove(),o.append(r),a){r.val(a);const o=n?n.find((e=>e.id===t)):null;if(o){const t=o.metrics.find((e=>e.id===a));t&&function(e,t,a){const n=e.find('label[for="criteria_value[]"]');let i;if(t.values&&"dropdown"===t.values.inputType)i=$('<select class="form-control" name="criteria_value[]"></select>'),t.values.values&&t.values.values.forEach((e=>{i.append(new Option(e.title,e.id))})),i.val(a);else{const e=t.values?t.values.inputType:"text";i=$('<input class="form-control" name="criteria_value[]" type="'+e+'" value="'+(a||"")+'" />')}n.find("input, select").remove(),n.append(i)}(e,t,i)}}}(l,r.type,r.metric,r.value)}))}else{const e=$(i({isAdd:!0})),a=e.find('select[name="criteria_type[]"]');o(a),t.append(e)}t.on("click","button",(function(e){e.preventDefault();const a=$(this);if(a.data("isAdd")){const e=$(i({isAdd:!1}));t.append(e);const n=e.find('select[name="criteria_type[]"]');o(n),a.data("isAdd",!0)}else a.closest(".form-group").remove()}))},processCriteriaFields=function(e,t){t.criteria=[],$.each(t.criteria_metric,(function(e,a){a&&t.criteria.push({id:t.criteria_id[e],type:t.criteria_type[e],metric:a,condition:t.criteria_condition[e],value:t.criteria_value[e]})})),delete t.criteria_id,delete t.criteria_type,delete t.criteria_metric,delete t.criteria_criteria,delete t.criteria_value};