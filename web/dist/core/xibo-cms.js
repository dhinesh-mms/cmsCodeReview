var lastForm,gridTimeouts=[],buttonsTemplate,autoSubmitTemplate=null;function XiboInitialise(t,a){null!=t&&""!=t||(t=" "),$(t+" .XiboGrid").each((function(){var e=$(this).data().gridName,t=$(this).find(".XiboFilter form");if(null!=e){var a;try{null==(a=JSON.parse(localStorage.getItem(e)))&&(localStorage.setItem(e,JSON.stringify(t.serializeArray())),a=JSON.parse(localStorage.getItem(e)))}catch(e){a=[]}let o=[];a.forEach((e=>{e.name in o?o[e.name].value=[e.value,o[e.name].value]:o[e.name]=e}));const i=new URL(window.location.href);var n=new URLSearchParams(i.search.slice(1));$.each(Object.values(o),(function(e,a){var o=a.name.replace(/\[\]/,"\\\\[\\\\]");try{var i=t.find('input[name="'+o+'"], select[name="'+o+'"], select[name="'+a.name+'"]');null!==n.get(o)?i.val(n.get(o)):i.length>0&&i.val(a.value),i.parent().hasClass("pagedSelect")&&i.data("initial-value",a.value)}catch(e){console.error("Error populating form saved value with selector input[name="+a.name+"], select[name="+a.name+"]")}}))}var o=_.debounce((function(){null!=e&&localStorage.setItem(e,JSON.stringify(t.serializeArray())),$(this).closest(".XiboGrid").find("table.dataTable").first().DataTable().ajax.reload()}),500),i=Handlebars.compile($("#xibo-filter-clear-button").html());$(this).find(".XiboFilter .nav-tabs").length>0?0===$(this).find(".XiboFilter .nav-tabs .clear-filter-btn-container").length&&t.length>0&&$(this).find(".XiboFilter .nav-tabs").append(i):0===$(this).find(".XiboFilter .clear-filter-btn-container").length&&t.length>0&&($(this).find(".XiboFilter").prepend(i),$(this).find(".XiboFilter .FilterDiv").addClass("pt-0")),$(this).find(".XiboFilter .clear-filter-btn").off().on("click",(function(e){t[0].reset(),t.find(".select2-hidden-accessible").val("").trigger("change"),t.find(".bootstrap-tagsinput").tagsinput("clear"),o.call(this)})),$(this).find(".XiboFilter form").on("keydown",(function(e){if(13==e.keyCode)return e.preventDefault(),!1})),$(this).find(".XiboFilter form input").on("keyup",o),$(this).find('.XiboFilter form input[type="number"]').on("change",o),$(this).find('.XiboFilter form input[type="checkbox"]').on("change",o),$(this).find(".XiboFilter form select").on("change",o),$(this).find(".XiboFilter form input.dateControl").on("change",o),$(this).find(".XiboFilter form #folderId").on("change",o),$(this).find('.XiboFilter form input[data-role="tagsInputInline"]').on("change",o);var r=rememberFolderTreeStateGlobally?"grid-folder-tree-state":"grid_"+e;initJsTreeAjax($(this).find("#container-folder-tree"),r,!1)})),$(t+" .XiboFormButton").click((function(){var e=$(this).data("eventStart"),t=$(this).data("eventEnd");if(void 0!==e&&void 0!==t){var a={eventStart:e,eventEnd:t};XiboFormRender($(this),a)}else XiboFormRender($(this));return!1})),$(t+" .XiboCustomFormButton").click((function(){return XiboCustomFormRender($(this)),!1})),$(t+" .XiboRedirectButton").click((function(){window.location=$(this).attr("href")})),$(t+" .XiboHoverButton").hover((function(e){return XiboHoverRender($(this).attr("href"),e.pageX,e.pageY),!1}),(function(){return!1})),$(t+" .XiboForm").validate({submitHandler:XiboFormSubmit,ignore:".datePickerHelper, :hidden>*:not(.flatpickr-input)",errorElement:"span",errorPlacement:function(e,t){$(t).hasClass("dateControl")?e.insertAfter(t.parent()):e.insertAfter(t)},highlight:function(e){$(e).closest(".form-group").removeClass("has-success").addClass("has-error")},success:function(e){$(e).closest(".form-group").removeClass("has-error").addClass("has-success")},invalidHandler:function(e,t){$(this).closest(".modal-dialog").find(".saving").remove(),$(this).closest(".modal-dialog").find(".save-button").removeClass("disabled")}}),$(t+" .XiboAjaxSubmit").click((function(){return $.ajax({type:"post",url:$(this).attr("href"),cache:!1,dataType:"json",success:XiboSubmitResponse}),!1})),$(t+" .XiboAutoForm").submit((function(){return XiboFormSubmit(this),!1})),$(t+" .XiboTextForm").validate({submitHandler:XiboFormSubmit,errorElement:"span",highlight:function(e){$(e).closest(".form-group").removeClass("has-success").addClass("has-error")},success:function(e){$(e).closest(".form-group").removeClass("has-error").addClass("has-success")}}),$(t+" .XiboHelpButton").click((function(){var e=$(this).attr("href");return window.open(e),!1})),$(t+" .dropdown-menu").on("click",(function(e){$(this).hasClass("dropdown-menu-form")&&e.stopPropagation()})),$(t+" .selectPicker select.form-control").select2({dropdownParent:$(t).hasClass("modal")?$(t):$("body"),templateResult:function(e){if(!e.id)return e.text;var t=$(e.element);return void 0!==t.data().content?$(t.data().content):e.text}}),$(t+" .pagedSelect select.form-control").each((function(){var e=$(this).data("anchorElement"),a=$(t).hasClass("modal");makePagedSelect($(this),void 0!==e&&""!==e?$(e):a?$(t):$("body"))})),$(t+" .localSelect select.form-control").each((function(){makeLocalSelect($(this),$(t).hasClass("modal")?$(t):$("body"))})),$(t+" span.notification-date").each((function(){$(this).html(moment($(this).html(),"X").fromNow())})),$(t+" input.bootstrap-switch-target").each((function(){$(this).bootstrapSwitch()})),$(t+" .colorpicker-input:not(.colorpicker-element)").each((function(){$(this).colorpicker({container:$(this).parent()})})),$(t+" input[data-role=tagsInputInline], "+t+" input[data-role=tagsInputForm], "+t+" select[multiple][data-role=tagsInputForm]").each((function(){var e=this,t=$(e).data("autoCompleteUrl");if(null!=t&&""!=t){var a=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,initialize:!1,remote:{url:t,prepare:function(e,t){return t.data={tag:e},t},filter:function(e){return $.map(e.data,(function(e){return{tag:e.tag}}))}},sorter:function(e,t){var a=e.tag.toUpperCase(),n=t.tag.toUpperCase();return a<n?-1:a>n?1:0}});a.initialize().done((function(){$(e).tagsinput({typeaheadjs:{name:"tags",displayKey:"tag",valueKey:"tag",source:a.ttAdapter()}})})).fail((function(){console.info("Auto-complete for tag failed! Using default..."),$(e).tagsinput()}))}else $(e).tagsinput();$(".bootstrap-tagsinput input").blur((function(){""!==$(this).val()&&($(e).tagsinput("add",$(this).val()),$(this).val(""))}))})),$(t+" .tags-with-value").length>0&&tagsWithValues($(t).find("form").attr("id")),$(t+" .XiboCommand").each((function(){var t=$(this),a=t.find("input");a.hide();var n={freetext:translations.freeTextCommand,tpv_led:"Philips Android",rs232:"RS232",intent:"Android Intent",http:"HTTP"},o=function(e){var n=a.val(),o=i(a.val()),l=t.find(".command-inputs"),s=Handlebars.compile($("#command-input-"+e+"-template").html());if(l.html(s({value:o.value,initVal:n,unique:(new Date).valueOf()})),"intent"==e){var d=Handlebars.compile($("#command-input-intent-extra-template").html());null!=o.value.extras&&o.value.extras.forEach((function(e){l.find(".intent-extra-container").append(d(e))})),l.find(".intent-add-extra").on("click",(function(){l.find(".intent-extra-container").append(d({})),r(e)})),l.off("click",".intent-remove-extra").on("click",".intent-remove-extra",(function(){$(this).parents(".intent-extra-element").remove(),r(e)}))}if("http"==e){var c=Handlebars.compile($("#command-input-http-key-value-template").html()),u=[".query-builder-container",".http-headers-container",".http-data-container"],f=[null!=o.value&&null!=o.value.query?o.value.query:null,null!=o.value&&null!=o.value.requestOptions&&null!=o.value.requestOptions.headers?o.value.requestOptions.headers:null,null!=o.value&&null!=o.value.requestOptions&&null!=o.value.requestOptions.body?o.value.requestOptions.body:null],p=function(e,t){e.find(".http-key-value-container").empty();for(let a=0;a<Object.keys(t).length;a++)e.find(".http-key-value-container").append(c({key:Object.keys(t)[a],value:Object.values(t)[a]}))},m=function(e){e=null!=e&&e;var t,a,n=$(this).parents(".request-section"),o=function(e){var t;try{t=JSON.parse(e)}catch(e){console.warn("Value not a JSON!")}return t},i=l.find(".http-contenttype").val();$(this).is(":checked")||e?n.find("textarea").hasClass("http-data")&&"application/json"!=i?"application/x-www-form-urlencoded"==i&&n.find("textarea").val(function(e){var t={};return e.find(".http-key-value-container .http-key-value-element").each((function(){var e=$(this),a=e.find(".http-key").val(),n=e.find(".http-value").val();[a,n].includes("")||(t[a]=n)})),Object.keys(t).map((e=>e+"="+t[e])).join("&")}(n)):n.find("textarea").val((a={},n.find(".http-key-value-container .http-key-value-element").each((function(){var e=$(this),t=e.find(".http-key").val(),n=e.find(".http-value").val();[t,n].includes("")?e.addClass("invalid"):(a[t]=n,e.removeClass("invalid"))})),JSON.stringify(a))):(n.find("textarea").hasClass("http-data")&&"application/json"!=i?"application/x-www-form-urlencoded"==i&&(t=o(function(e){var t;try{t='{"'+decodeURI(e.replace(/&/g,'","').replace(/=/g,'":"'))+'"}'}catch(e){console.warn("Decode URI failed!")}return t}(n.find("textarea").val()))):t=o(n.find("textarea").val()),t&&p(n,t))};for(let t=0;t<f.length;t++){var h=f[t],g=l.find(u[t]);null!=h&&p(g,h),g.find(".http-key-value-add").on("click",(function(t){$(this).parent().find(".http-key-value-container").append(c({})),r(e)})),g.off("click",".http-key-value-remove").on("click",".http-key-value-remove",(function(t){$(this).parents(".http-key-value-element").remove(),r(e)})),g.parent().find('.form-check input[type="checkbox"]').off("change").on("change",(function(){$(this).hasClass("show-raw-headers")||$(this).hasClass("show-raw-data")?m.bind(this)():r(e);var t=$(this).parents(".request-section");t.find($(this).data("toggleElement")).toggleClass($(this).data("toggleClass"),$(this).is(":checked")),t.find($(this).data("toggleElementReverse")).toggleClass($(this).data("toggleClass"),!$(this).is(":checked"))})),g.parent().off("change",".http-key-value-container .http-key-value-element input").on("change",".http-key-value-container .http-key-value-element input",(function(){m.bind(this)(!0)})),m.bind(g)(!0)}l.find(".http-contenttype").off("change").on("change",(function(){var e="text/plain"==$(this).val();l.find(".show-raw-data").parent().toggleClass("d-none",e),l.find(".show-raw-data").prop("checked",e).trigger("change"),e||m.bind($(".http-data-container"))(!0)}))}l.off("change","input:not(.ignore-change), select, textarea").on("change","input:not(.ignore-change), select, textarea",(function(){r(e)})),r(e)},i=function(e){var t={};if(""==e||null==e)t.type="freetext",t.value="";else{var a=e.split("|");if(1==a.length)t.type="freetext",t.value=e;else switch(t.type=a[0],t.type){case"intent":t.value={type:a[1],name:a[2],extras:a.length>3?JSON.parse(a[3]):[]};break;case"rs232":var n=a[1].split(","),o={deviceName:n[0],baudRate:n[1],dataBits:n[2],parity:n[3],stopBits:n[4],handshake:n[5],hexSupport:n[6]};t.value={cs:o,command:a[2]};break;case"tpv_led":t.type="tpv_led",t.value=a[1];break;case"http":var i={},r=a[2];if(null!=a[3])try{i=JSON.parse(a[3])}catch(e){console.warn("Skip JSON parse!")}if(null!=i.headers)try{i.headers=JSON.parse(i.headers)}catch(e){console.warn("Skip headers JSON parse!")}if(null!=i.body)try{if(r)if("application/json"==r)i.body=JSON.parse(i.body);else if("application/x-www-form-urlencoded"==r){var l=decodeURI(i.body).split("&"),s={};l.forEach((e=>{var t=e.split("=");(t.length=2)&&(s[t[0]]=t[1])})),i.body=s}}catch(e){console.warn("Skip body parse!")}t.type="http",t.value={url:a[1],contenttype:a[2],requestOptions:i};break;default:t.type="freetext",t.value=e}}return t},r=function(n){var o="",i=!1,r=t.find(".command-inputs");switch(n){case"tpv_led":o="tpv_led|"+r.find(".tpv-led-command").val();break;case"http":var l=r.find(".http-url").val(),s={};if(""==l?(i=!0,r.find(".http-url").addClass("invalid")):r.find(".http-url").removeClass("invalid"),r.find(".show-query-builder").is(":checked")){if(2==l.split("?").length){var d=l.split("?")[1],c=[];try{c=decodeURI(d).split("&")}catch(e){console.warn("malformed URI:"+e)}l=l.split("?")[0];for(let e=0;e<c.length;e++){var u=c[e].split("=");2==u.length&&(s[u[0]]=u[1])}}r.find(".query-builder-container .http-key-value-container .http-key-value-element").each((function(){var t=$(this);t.removeClass("invalid");var a=t.find(".http-key").val(),n=t.find(".http-value").val();try{a=encodeURI(a),n=encodeURI(n)}catch(t){console.warn("malformed URI:"+e),a="",n=""}[a,n].includes("")?(i=!0,t.addClass("invalid")):(s[a]=n,t.removeClass("invalid"))}));var f=Object.keys(s).map((e=>e+"="+s[e])).join("&");l+=""!=f?"?"+encodeURI(f):""}var p={};p.method=r.find(".http-method").val();var m=r.find(".http-contenttype").val(),h=r.find(".http-headers").val();r.find(".http-headers").parent().removeClass("invalid");try{JSON.parse(h),p.headers=h}catch(e){console.warn("Invalid headers: "+e),i=!0,r.find(".http-headers").parent().addClass("invalid")}var g=r.find(".http-data").val();r.find(".http-data").parent().removeClass("invalid");try{"application/json"==m?JSON.parse(g):"application/x-www-form-urlencoded"==m&&decodeURI(g),p.body=g}catch(e){console.warn("Invalid body: "+e),i=!0,r.find(".http-data").parent().addClass("invalid")}"object"==typeof p&&(p=JSON.stringify(p)),o="http|",o+=l+"|",o+=m+"|",o+=p;break;case"rs232":var v=r.find(".rs232-device-name").val(),b=r.find(".rs232-baud-rate").val(),y=r.find(".rs232-data-bits").val(),x=r.find(".rs232-parity").val(),k=r.find(".rs232-stop-bits").val(),T=r.find(".rs232-handshake").val(),w=r.find(".rs232-hex-support").val(),C=r.find(".rs232-command").val();r.find(".rs232-device-name").toggleClass("invalid",""==v),r.find(".rs232-baud-rate").toggleClass("invalid",""==b),r.find(".rs232-data-bits").toggleClass("invalid",""==y),[v,b,y].includes("")&&(i=!0),o="rs232|",o+=""!=v?v+",":"",o+=""!=b?b+",":"",o+=""!=y?y+",":"",o+=""!=x?x+",":"",o+=""!=k?k+",":"",o+=""!=T?T+",":"",o+=w,o+="|"+C;break;case"intent":o="intent|"+r.find(".intent-type").val()+"|"+r.find(".intent-name").val(),""==r.find(".intent-name").val()?(r.find(".intent-name").addClass("invalid"),i=!0):r.find(".intent-name").removeClass("invalid");var S=[];r.find(".intent-extra-element").each((function(){var e=$(this);e.removeClass("invalid");var t=e.find(".extra-name").val(),a=e.find(".extra-type").val(),n=e.find(".extra-value").val();if("intArray"==a){n=n.replace(" ","").split(",").map((function(e){return""!=e?Number(e):""}));for(var o=0;o<n.length;o++){var r=n[o];if(isNaN(r)||""==r){n="";break}}}else"int"==a&&""!=n?n=isNaN(Number(n))?"":Number(n):"bool"==a&&""!=n&&(n="true"==n);[t,a,n].includes("")?(i=!0,e.addClass("invalid")):S.push({name:t,type:a,value:n})})),S.length>0&&(o+="|"+JSON.stringify(S));break;default:o=r.find(".free-text").val()}i?(a.val(""),t.find(".command-preview code").text(t.find(".command-preview").data("invalidMessage")),t.find(".command-preview").addClass("invalid")):(a.val(o),t.find(".command-preview code").text(o),t.find(".command-preview").removeClass("invalid"))},l=i(a.val()).type,s=Handlebars.compile($("#command-input-main-template").html());a.before(s({types:n,type:l,unique:(new Date).valueOf()})),o(l),$(this).find(".command-type").change((function(){o($(this).val())})),$(this).find(".show-command-preview").change((function(){t.find(".command-preview").toggle($(this).is(":checked"))})),a.attr("readonly","readonly")})),$(t+" .XiboColorPicker").each((function(){createColorPicker(this)})),$(t+" .XiboData").on("shown.bs.dropdown",".dropdown-menu-container",(function(e){var t=$(this).find(".dropdown-menu.show");setTimeout((function(){t.offset().top<0&&t.offset({top:0,left:t.offset().left})}),200)})),$(t+" #fullScreenCampaignId").each((function(){let e,t=$(this).closest("form"),a=parseInt(t.find("#eventTypeId").val()),n=t.find("#fullScreen-mediaId").val(),o=t.find("#fullScreen-playlistId").val(),i={};null!=n&&""!==n?(i={mediaId:n},e=t.data().libraryGetUrl):null!=o&&null!=o&&""!==o&&(i={playlistId:o},e=t.data().playlistGetUrl),null!=e&&[7,8].includes(a)&&$.ajax({type:"GET",url:e,cache:!1,dataType:"json",data:i}).then((e=>{e.success||SystemMessageInline(""===e.message?translations.failure:e.message,t.closest(".modal")),7==a?t.find("#fullScreen-media").val(e.data[0].name):8==a&&t.find("#fullScreen-playlist").val(e.data[0].name),e.data[0]?.fullScreenCampaignId&&t.find("#fullScreenCampaignId").val(e.data[0].fullScreenCampaignId).trigger("change"),e.data[0]?.hasFullScreenLayout||(7==a?t.find("#fullScreenControl_media").trigger("autoOpen"):8==a&&t.find("#fullScreenControl_playlist").trigger("autoOpen"))}),(e=>{SystemMessage(e.responseText,!1)}))})),$(t+" .full-screen-layout-form").on("click autoOpen",(function(e){0!=$("#full-screen-schedule-modal").length&&$("#full-screen-schedule-modal").remove();let a=$(e.currentTarget),n=a.parents(t),o=a.closest("form").find("#eventTypeId").val(),i=a.closest("form").find("#fullScreen-mediaId").val(),r=a.closest("form").find("#fullScreen-playlistId").val(),l=a.data("readonly");if(0===$("#full-screen-schedule-modal").length){const t=Handlebars.compile($("#full-screen-schedule-template").html()),a={type:7==o?"Media":"Playlist",eventTypeId:o,readonlySelect:l};$("body").append(t(a));const s=$("#full-screen-schedule-modal");"autoOpen"===e.type&&s.find("button.close").on("click",(function(){n.modal("hide")})),s.on("show.bs.modal",(function(){$(".no-full-screen-layout").addClass("d-none")})).on("shown.bs.modal",(function(){const e=s.find("form");e.find(".pagedSelect select.form-control").each((function(){"mediaId"==$(this).attr("id")&&null!=i?$(this).data("initialValue",i):"playlistId"==$(this).attr("id")&&null!=r&&$(this).data("initialValue",r),makePagedSelect($(this),"#"+e.attr("id"))})),e.find(".colorpicker-input:not(.colorpicker-element)").each((function(){$(this).colorpicker({container:$(this).parent()})})),$("#mediaId, #playlistId",e).on("select2:select",(function(e){let t=!1;void 0!==e.params.data.data?t=e.params.data.data[0].hasFullScreenLayout:void 0!==e.params.data.hasFullScreenLayout&&(t=e.params.data.hasFullScreenLayout),t?$(".no-full-screen-layout").addClass("d-none"):"mediaId"===$(this).attr("id")?$(".no-full-screen-layout").removeClass("d-none"):$(".no-full-screen-layout.media-playlist-control").removeClass("d-none")})),l&&e.find("#mediaId, #playlistId").prop("disabled",!0);const t=$(".resolution-control"),a=e.find("#resolutionId");7==o?t.children("div").children("small.form-text.text-muted").text(a.data("transMediaHelpText")):8==o&&t.children("div").children("small.form-text.text-muted").text(a.data("transPlaylistHelpText")),$("#btnFullScreenLayoutConfirm").on("click",(function(t){t.preventDefault(),fullscreenBeforeSubmit(e)}))})).on("hidden.bs.modal",(function(){$(".modal:visible").length&&$(document.body).addClass("modal-open"),$(this).data("bs.modal",null)})),s.modal({backdrop:"static",keyboard:!1,show:!0})}})),forms&&"function"==typeof forms.initFields&&forms.initFields(" "===t?"body":t,null,a&&a.targetId?a.targetId:null,!(!a||!a.readOnlyMode)&&a.readOnlyMode)}function dataTableProcessing(e,t,a){a?0===$(e.target).closest(".widget").closest(".widget").find(".saving").length&&$(e.target).closest(".widget").children(".widget-title").append('<span class="saving fa fa-cog fa-spin p-1"></span>'):$(e.target).closest(".widget").closest(".widget").find(".saving").remove()}function dataTableDraw(e,t,a){var n=$("#"+e.target.id),o=n.find("div.dropdown-menu a.multi-select-button"),i=n.closest(".XiboGrid").find(".FilterDiv #tags"),r=n.closest(".XiboGrid").find(".folder-controller");if(o.length>0){n.find("tbody").off("click","tr").on("click","tr",(function(){$(this).toggleClass("selected"),n.data().initialised=!0}));var l=Handlebars.compile($("#multiselect-button-template").html()),s=[];$(o).each((function(){(function(e,t,a){for(var n in e)if(e[n].id==a)return!0;return!1})(s,0,$(this).data("id"))||s.push({id:$(this).data("id"),gridId:e.target.id,text:$(this).data("text"),customHandler:$(this).data("customHandler"),customHandlerUrl:$(this).data("customHandlerUrl"),contentIdName:$(this).data("contentIdName"),sortGroup:null!=$(this).data("sortGroup")?$(this).data("sortGroup"):0})})),i.length>0&&1==userRoutePermissions.tags&&s.push({id:i.attr("id"),gridId:e.target.id,text:translations.editTags,contentType:n.data("contentType"),contentIdName:n.data("contentIdName"),customHandler:"XiboMultiSelectTagFormRender",sortGroup:0});var d=0;if((s=s.sort((function(e,t){return e.sortGroup>t.sortGroup?1:-1}))).length>1)for(var c=0;c<s.length;c++){var u=s[c];u.sortGroup>d&&c>0&&(s.splice(c,0,{divider:!0}),d=u.sortGroup)}var f=l({selectAll:translations.selectAll,withSelected:translations.withselected,buttons:s});n.closest(".dataTables_wrapper").find(".dataTables_info").prepend(f),n.closest(".dataTables_wrapper").find(".dataTables_info a.XiboMultiSelectFormButton").click((function(){null!=$(this).data("customHandler")&&"function"==typeof window[$(this).data("customHandler")]?window[$(this).data("customHandler")](this):XiboMultiSelectFormRender(this)})),n.closest(".dataTables_wrapper").find(".dataTables_info a.XiboMultiSelectFormCustomButton").click((function(){window[$(this).data("customHandler")](this)})),n.closest(".dataTables_wrapper").find(".dataTables_info button.select-all").click((function(){var e=n.find("tbody tr");n.find("tbody tr.selected").length>e.length/2?e.removeClass("selected"):e.addClass("selected")}))}r.length>0&&0==n.closest(".dataTables_wrapper").find(".dataTables_folder .folder-controller").length&&(r.appendTo(".dataTables_folder"),r.removeClass("d-none").addClass("d-inline-flex")),"function"==typeof a&&a(),XiboInitialise("#"+e.target.id)}function dataTableButtonsColumn(e,t,a,n){return"display"!=t||e.buttons.length<=0?"":(null==buttonsTemplate&&(buttonsTemplate=Handlebars.compile($("#buttons-template").html())),buttonsTemplate({buttons:e.buttons}))}function dataTableTickCrossColumn(e,t,a){return"display"!=t?e:"<span class='fa "+(1==e?"fa-check":0==e?"fa-times":"fa-exclamation")+"'></span>"}function dataTableTickCrossInverseColumn(e,t,a){return"display"!=t?e:"<span class='fa "+(1==e?"fa-times":0==e?"fa-check":"fa-exclamation")+"'></span>"}function dataTableDateFromIso(e,t,a){return"display"!==t&&"export"!==t?e:null==e?"":moment(e,systemDateFormat).format(jsDateFormat)}function dataTableRoundDecimal(e,t,a){return"display"!==t&&"export"!==t?e:null==e?"":parseFloat(e).toFixed(2)}function dataTableDateFromUnix(e,t,a){return"display"!==t&&"export"!==t?e:null==e||0==e?"":moment(e,"X").tz?moment(e,"X").tz(timezone).format(jsDateFormat):moment(e,"X").format(jsDateFormat)}function dataTableTimeFromSeconds(e,t,a){if("display"!==t&&"export"!==t)return e;if(null==e||0==e)return"";var n=moment.duration(1e3*e),o=Math.floor(n.asHours());return(o<10?"0"+o:o)+moment.utc(n.asMilliseconds()).format(":mm:ss")}function dataTableSpacingPreformatted(e,t,a){return"display"!==t?e:null===e||""===e?"":'<span class="spacing-whitespace-pre">'+e+"</span>"}function dataTableCreateTags(e,t){if("display"!==t)return e.tags;var a="";return void 0!==typeof e.tags&&null!=e.tags&&(a+='<div id="tagDiv">',e.tags.forEach((e=>a+='<li class="btn btn-sm btn-white btn-tag">'+e.tag+(e.value?"|"+e.value:"")+"</li>")),a+="</div>"),a}function dataTableCreatePermissions(e,t){if("display"!==t)return e;var a="";if(null!=typeof e&&null!=e){var n=e.split(",");a+='<div class="permissionsDiv">';for(var o=0;o<n.length;o++)""!=n[o]&&(a+='<li class="badge">'+n[o]+"</span></li>");a+="</div>"}return a}function dataTableCreateTagEvents(e,t){var a=$("#"+e.target.id),n=e.target.id,o=e.data.form;a.off("click"),a.on("click",".btn-tag",(function(e){var t=$(this).text();o.find("#tags").val(),"playlistLibraryMedia"==n?(o.find("#filterMediaTag").val(),o.find("#filterMediaTag").tagsinput("add",t,{allowDuplicates:!1})):"displayGroupDisplays"==n?(o.find("#dynamicCriteriaTags").val(),o.find("#dynamicCriteriaTags").tagsinput("add",t,{allowDuplicates:!1})):o.find("#tags").tagsinput("add",t,{allowDuplicates:!1}),a.DataTable().ajax.reload()}))}function dataTableConfigureRefresh(e,t,a){for(var n=a>10?a:10,o=gridTimeouts.length-1;o>=0;o--)gridTimeouts[o].label===e&&(clearTimeout(gridTimeouts[o].timer),gridTimeouts.splice(o,1));gridTimeouts.push({label:e,timer:setTimeout((function(){t.reload()}),1e3*n)})}function dataTableAddButtons(e,t,a,n){a=void 0===a||a;let o=[{extend:"colvis",columns:":not(.rowMenu)",text:function(e,t,a){return e.i18n("buttons.colvis")}}];(n=void 0!==n&&n)&&o.push({text:translations.defaultSorting,action:function(t,a,n,o){e.order([]).draw()}}),a&&o.push({extend:"print",text:function(e,t,a){return e.i18n("buttons.print")},exportOptions:{orthogonal:"export",format:{body:function(e,t,a,n){return null===e||""===e||"null"===e?"":e}}},customize:function(e){let t=$(e.document.body).find("table");t.removeClass("nowrap responsive dataTable no-footer dtr-inline"),t.find("th").length>16&&(t.addClass("table-sm"),t.css("font-size","6px"))}},{extend:"csv",exportOptions:{orthogonal:"export",format:{body:function(e,t,a,n){return null===e||""===e?"":e}}}}),new $.fn.dataTable.Buttons(e,{buttons:o}),e.buttons(0,null).container().prependTo(t),$(t).addClass("text-right"),$(".ColVis_MasterButton").addClass("btn"),$(t).find(".dt-buttons button.btn-secondary").addClass("btn-outline-primary").removeClass("btn-secondary")}function dataTableStateLoadCallback(e,t){var a=$("#"+e.sTableId).data().statePreferenceName,n=void 0!==a?a:e.sTableId+"Grid",o={};return $.ajax({type:"GET",async:!1,url:userPreferencesUrl+"?preference="+n,dataType:"json",success:function(e){try{e.success&&(o=JSON.parse(e.data.value))}catch(e){}}}),o}function dataTableStateSaveCallback(e,t){var a=$("#"+e.sTableId).data().statePreferenceName;updateUserPref([{option:void 0!==a?a:e.sTableId+"Grid",value:JSON.stringify(t)}],(function(){}))}function XiboFormRender(sourceObj,data=null){var formUrl="";return"string"==typeof sourceObj||sourceObj instanceof String?formUrl=sourceObj:(formUrl=sourceObj.attr("href"),sourceObj.removeAttr("href")),null==formUrl||(lastForm=formUrl,$.ajax({type:"get",url:formUrl,cache:!1,dataType:"json",data:data,success:function(response){if(("object"==typeof sourceObj||sourceObj instanceof Object)&&sourceObj.attr("href",lastForm),response.success){if(!("string"==typeof sourceObj||sourceObj instanceof String)){var commitUrl=sourceObj.data().commitUrl;if(response.autoSubmit&&void 0!==commitUrl)return $.ajax({type:sourceObj.data().commitMethod||"POST",url:commitUrl,cache:!1,dataType:"json",success:function(e){e.success?(""!==e.message&&SystemMessage(e.message,!0),XiboRefreshAllGrids()):e.login?LoginBox(e.message):SystemMessageInline(e.message)},error:function(e){SystemMessageInline(e.responseText)}}),!1}var dialogTitle="";null!=response.dialogTitle&&""!=response.dialogTitle&&(dialogTitle=response.dialogTitle);var id=(new Date).getTime(),size="large";sourceObj&&"object"==typeof sourceObj&&(size=sourceObj.data().modalSize||"large"),bootbox.hideAll();var dialog=bootbox.dialog({message:response.html,title:dialogTitle,animate:!1,size:size}).attr("id",id);if(dialog.data("extra",response.extra),""!==response.buttons){var footer=$("<div>").addClass("modal-footer");dialog.find(".modal-content").append(footer);var i=0,count=Object.keys(response.buttons).length;$.each(response.buttons,(function(index,value){i++;var extrabutton=$('<button id="dialog_btn_'+i+'" class="btn">').html(index);i===count?extrabutton.addClass("btn-primary save-button"):extrabutton.addClass("btn-white"),extrabutton.click((function(e){e.preventDefault();var $button=$(this);if($button.hasClass("save-button")){if($button.hasClass("disabled"))return!1;$button.append(' <span class="saving fa fa-cog fa-spin"></span>'),$button.addClass("disabled")}return eval(value),!1})),footer.append(extrabutton)})),"string"==typeof sourceObj||sourceObj instanceof String||sourceObj.data().autoSubmit&&(null===autoSubmitTemplate&&(autoSubmitTemplate=Handlebars.compile($("#auto-submit-field-template").html())),footer.prepend(autoSubmitTemplate()))}$("input[type=text]",dialog).not(".dateControl").eq(0).focus(),$("input[type=text]",dialog).each((function(e,t){formRenderDetectSpacingIssues(t),$(t).on("keyup",_.debounce((function(){formRenderDetectSpacingIssues(t)}),500))})),""!=response.fieldActions&&$.each(response.fieldActions,(function(e,t){if("init"==t.trigger){var a=$("#"+t.field).val();("not"==t.operation?a!=t.value:"is:checked"==t.operation?t.value==$("#"+t.field).is(":checked"):a==t.value)&&$.each(t.actions,(function(e,t){var a=$(e);a.data("initActioned")||a.css(t).data("initActioned",!0)}))}else $("#"+t.field).on(t.trigger,(function(){var e=$(this).val();("not"==t.operation?e!=t.value:"is:checked"==t.operation?t.value==$("#"+t.field).is(":checked"):e==t.value)&&$.each(t.actions,(function(e,t){$(e).css(t)}))}))})),$('a[data-toggle="tab"]',dialog).on("shown.bs.tab",(function(e){1===$(e.target).data().enlarge?$(e.target).closest(".modal").addClass("modal-big"):$(e.target).closest(".modal").removeClass("modal-big")})),$('a[data-toggle="tab"]',dialog).each((function(){1===$(this).data().enlarge&&$(this).closest("li").hasClass("active")&&$(this).closest(".modal").addClass("modal-big")})),0!=$("#folder-tree-form-modal").length&&$("#folder-tree-form-modal").remove(),XiboInitialise("#"+dialog.attr("id")),null!=dialog.find(".XiboForm").attr("id")&&(void 0!==$("#container-folder-tree").jstree("get_selected",!0)[0]&&""==$("#"+dialog.find(".XiboForm").attr("id")+" #folderId").val()&&$("#"+dialog.find(".XiboForm").attr("id")+" #folderId").val($("#container-folder-tree").jstree("get_selected",!0)[0].id),initJsTreeAjax("#container-folder-form-tree",dialog.find(".XiboForm").attr("id"),!0,600)),""!==response.callBack&&void 0!==response.callBack&&eval(response.callBack)(dialog)}else{if(response.login)return LoginBox(response.message),!1;null==response.message?SystemMessage(response):SystemMessage(response.message)}return!1},error:function(e){SystemMessage(e.responseText)}})),!1}function XiboCustomFormRender(e){var t;return t=e.attr("href"),e.removeAttr("href"),null==t||(lastForm=t,$.ajax({type:"get",url:t,cache:!1,dataType:"json",success:function(t){if(("object"==typeof e||e instanceof Object)&&e.attr("href",lastForm),t.success){var a={id:(new Date).getTime(),buttons:t.buttons,data:t.data,title:t.dialogTitle,message:t.html,extra:t.extra};""!==t.callBack&&void 0!==t.callBack&&window[t.callBack](a)}else{if(t.login)return LoginBox(t.message),!1;null==t.message?SystemMessage(t):SystemMessage(t.message)}return!1},error:function(e){SystemMessage(e.responseText)}})),!1}function XiboRemoteRequest(e,t,a){$.ajax({type:"post",url:e,cache:!1,dataType:"json",data:t,success:a,error:function(e){SystemMessage(e.responseText)}})}function formRenderDetectSpacingIssues(e){var t=$(e),a=t.val();if(""!==a&&(a.startsWith(" ")||a.endsWith(" ")||a.indexOf("  ")>-1)){console.debug("Field with strange spacing: "+t.attr("name"));var n=$("<span></span>").addClass("fa fa-exclamation-circle spacing-warning-icon").attr("title",translations.spacesWarning);t.parent().append(n)}else t.parent().find(".spacing-warning-icon").remove()}function XiboMultiSelectFormRender(button){var buttonId=$(button).data().buttonId,matches=[],formOpenCallback=null,message;$("."+buttonId).each((function(){$(this).closest("tr").hasClass("selected")&&(matches.push($(this)),1===matches.length&&(formOpenCallback=$(this).data().formCallback,formConfirm=$(this).data().formConfirm))})),message=matches.length>0?translations.multiselectMessage.replace("%1",""+matches.length).replace("%2",$(button).html()):translations.multiselectNoItemsMessage;var dialog=bootbox.dialog({message:message,title:translations.multiselect,animate:!1,size:"large"}),dialogContent=dialog.find(".modal-body"),footer=$("<div>").addClass("modal-footer"),extrabutton;dialog.find(".modal-content").append(footer),null!=formOpenCallback&&eval(formOpenCallback)(dialog),matches.length>0&&(extrabutton=$('<button class="btn">').html(translations.save).addClass("btn-primary save-button"),formConfirm&&extrabutton.prop("disabled",!0),extrabutton.click((function(){return $(this).append(' <span class="saving fa fa-cog fa-spin"></span>'),window.queue=$.jqmq({delay:-1,batch:1,callback:function(e){var t=$(e).data();void 0!==dialog.data().commitData&&(t=$.extend({},t,dialog.data().commitData)),$.ajax({type:t.commitMethod,url:t.commitUrl,cache:!1,dataType:"json",data:t,success:function(e,a,n){e.success?(dialogContent.append($("<div>").html(t.rowtitle+": "+translations.success)),queue.next()):e.login?LoginBox(e.message):(dialogContent.append($("<div>").html(t.rowtitle+": "+translations.failure)),footer.find(".saving").remove(),SystemMessageInline(e.message,footer.closest(".modal")))},error:function(e){SystemMessage(e,!1)}})},complete:function(){footer.find(".saving").parent().remove(),XiboRefreshAllGrids()}}),$(matches).each((function(){queue.add(this)})),queue.start(),!1})),footer.append(extrabutton)),extrabutton=$('<button class="btn">').html(translations.close).addClass("btn-white"),extrabutton.click((function(){return $(this).append(' <span class="saving fa fa-cog fa-spin"></span>'),dialog.modal("hide"),$(".modal").hasClass("in")&&$("body").addClass("modal-open"),!1})),footer.append(extrabutton)}function XiboMultiSelectPermissionsFormOpen(e){var t=$(e).parents(".XiboGrid").find(".dataTable"),a=t.find("tr.selected"),n=t.DataTable(),o=$(e).data("customHandlerUrl"),i=$(e).data("contentIdName"),r=[];a.each((function(e,t){var a=n.row(t).data();r.push(a[i])})),0==a.length?bootbox.dialog({message:translations.multiselectNoItemsMessage,title:translations.multiselect,animate:!1,size:"large",buttons:{cancel:{label:translations.close,className:"btn-white btn-bb-cancel"}}}):XiboFormRender(o,{ids:r.toString()})}function XiboMultiSelectTagFormRender(e){var t=$(e).data("contentType"),a=$(e).data("contentIdName"),n=[],o=$(e).parents(".XiboGrid").find(".dataTable"),i=o.DataTable(),r="",l="multiselectTagEditForm",s=[],d=[];o.find("tr.selected").each((function(){n.push($(this))})),0==n.length?r=translations.multiselectNoItemsMessage:(n.forEach((function(e){var t=i.row(e).data();s.push(t[a]),-1===["",null].indexOf(t.tags)&&t.tags.forEach((function(e){-1===d.indexOf(e)&&d.push(e.tag+(e.value?"|"+e.value:""))}))})),r=Handlebars.compile($("#multiselect-tag-edit-form-template").html()));var c,u=bootbox.dialog({message:r,title:translations.multiselect,size:"large",animate:!1}),f=u.find(".modal-body"),p=$("<div>").addClass("modal-footer");if(u.find(".modal-content").append(p),u.attr("id",l),n.length>0){if((c=$('<button class="btn">').html(translations.save).addClass("btn-primary save-button")).click((function(){var e,a=f.find("#tagsToRemove").val().split(","),n=f.find("#requestURL").val(),o={targetIds:s.toString(),targetType:t,addTags:f.find("#tagsToAdd").val(),removeTags:(e=[],d.forEach((function(t){-1==a.indexOf(t)&&e.push(t)})),e).toString()};return $(this).append('<span class="saving fa fa-cog fa-spin"></span>'),$.ajax({type:"PUT",url:n,cache:!1,dataType:"json",data:o,success:function(e,t,a){e.success?(toastr.success(e.message),u.modal("hide"),i.ajax.reload(null,!1)):(e.login?LoginBox(e.message):(p.find(".saving").remove(),SystemMessageInline(e.message,p.closest(".modal"))),$(this).find(".saving").remove())},error:function(e){SystemMessage(e,!1),$(this).find(".saving").remove()}}),!1})),p.append(c),d.length>0){var m=d.toString();f.find("#tagsToRemove").val(m)}else f.find("#tagsToRemoveContainer").hide();f.find("#requestURL").val(f.find("#requestURL").val().replace("[type]",t)),f.find("#tagsToRemove").on("beforeItemAdd",(function(e){e.cancel=-1==d.indexOf(e.item)}))}(c=$('<button class="btn">').html(translations.close).addClass("btn-white")).click((function(){return $(this).append(' <span class="saving fa fa-cog fa-spin"></span>'),u.modal("hide"),$(".modal").hasClass("in")&&$("body").addClass("modal-open"),!1})),p.prepend(c),XiboInitialise("#"+l)}function XiboPing(e,t){$.ajax({type:"get",url:e,cache:!1,dataType:"json",success:function(e){if(e.success)null!=t&&$(t).html(e.html),e.clockUpdate&&XiboClockUpdate(e.html);else if(e.login)return LoginBox(e.message),!1;return!1}})}function XiboClockUpdate(e){$("#XiboClock").html(e)}function XiboFormSubmit(e,t,a){var n=$(e),o=n.attr("action");return formHelpers.updateCKEditor(),$.ajax({type:n.attr("method"),url:o,cache:!1,dataType:"json",data:n.serialize(),success:function(t,o,i){if(XiboSubmitResponse(t,e),null!=a&&null!=a)a(t,e);else{var r=n.data("submitCallBack");r&&"function"==typeof window[r]&&window[r](t,e)}},error:function(e,t,a){SystemMessage(e.responseText,!1)}}),n.closest(".modal-dialog").find("input[name=autoSubmit]").is(":checked")&&updateUserPref([{option:"autoSubmit."+n.attr("id"),value:!0}]),!1}function XiboSubmitResponse(response,form){$(form).closest(".modal-dialog").find(".saving").remove();var apply=$(form).data("apply");if($(form).data("apply",!1),response.success){if(""!=response.message&&SystemMessage(response.message,!0),null!=apply&&apply?($(form).data("applyCallback")&&eval($(form).data("applyCallback"))(form),$(form).closest(".modal-dialog").find(".form-error").remove(),$("input[type=text]",form).eq(0).focus()):bootbox.hideAll(),XiboRefreshAllGrids(),!apply&&void 0!==$(form).data("nextFormUrl")){var responseId=void 0===$(form).data("nextFormIdProperty")?response.id:response.data[$(form).data("nextFormIdProperty")];XiboFormRender($(form).data().nextFormUrl.replace(":id",responseId))}}else response.login?LoginBox(response.message):SystemMessageInline(response.message,$(form).closest(".modal"));return!1}function XiboHoverRender(url,x,y){return $.ajax({type:"get",url:url,cache:!1,dataType:"json",success:function(response){if(response.success){var dialogWidth="500",dialogHeight="500";response.dialogSize&&(dialogWidth=response.dialogWidth,dialogHeight=response.dialogHeight),$("body").append('<div class="XiboHover"></div>'),$(".XiboHover").css("position","absolute").css({display:"none",width:dialogWidth,height:dialogHeight,top:y,left:x}).fadeIn("slow").hover((function(){return!1}),(function(){return $(".XiboHover").hide().remove(),!1})),$(".XiboHover").html(response.html),""!=response.callBack&&null!=response.callBack&&eval(response.callBack)(name),XiboInitialise(".XiboHover")}else{if(response.login)return LoginBox(response.message),!1;null==response.message?SystemMessage(response):SystemMessage(response.message)}return!1}}),!1}function XiboDialogClose(e){e=void 0!==e,bootbox.hideAll(),e&&XiboRefreshAllGrids()}function XiboDialogApply(e){var t=$(e);t.data("apply",!0),t.submit()}function XiboSwapDialog(e,t){bootbox.hideAll(),XiboFormRender(e,t)}function XiboRefreshAllGrids(){$(" .XiboGrid table.dataTable").each((function(){const e=$(this).closest(".XiboGrid").data("refreshOnFormSubmit");if(null==e||e){const e=$(this).DataTable();e.init().serverSide&&e.ajax.reload(null,!1)}}))}function XiboRedirect(e){window.location.href=e}function LoginBox(e){window.location.reload()}function updateUserPref(e,t){null==t&&(t=function(e){return e.success?SystemMessage(e.message,!0):e.login?LoginBox(e.message):SystemMessage(e.message,e.success),!1}),$.ajax({type:"post",url:userPreferencesUrl,cache:!1,dataType:"json",data:{preference:e},success:t})}function SystemMessage(e,t){if(""!=e&&null!=e)if(t)toastr.success(e);else var a=bootbox.dialog({message:e,title:"Application Message",size:"large",buttons:[{label:"Close",className:"btn-bb-close",callback:function(){a.modal("hide")}}],animate:!1})}function SystemMessageInline(e,t){""!=e&&null!=e&&(null!=t&&null!=t&&0!=t.length||(t=$(".modal")),t.length<=0?toastr.error(e):($(".form-error",t).remove(),$(t).find(".btn").removeClass("disabled"),$("<div/>",{class:"card bg-light p-3 text-danger col-sm-12 text-center form-error",html:e}).appendTo(t.find(".modal-footer"))))}function ToggleFilterView(e){"none"==$(e).css("display")?$(e).fadeIn("slow"):$(e).fadeOut("slow")}function makePagedSelect(e,t,a,n=!1){if(!0===n){const t=Math.floor(1e9+9e9*Math.random()),a=$(e).attr("id"),n=a?a+"_"+t:t;$(e).attr("data-select2-id",n)}if(e.select2({dropdownParent:null==t?$("body"):$(t),minimumResultsForSearch:e.data("hideSearch")?1/0:1,ajax:{url:e.data("searchUrl"),dataType:"json",delay:250,data:function(t){var a={start:0,length:10},n=t.term;if(null!=n&&null!=e.data("searchTermTags")){var o=n.match(/\[([^}]+)\]/),i="";null!=o&&(i=o[1],n=n.replace(o[0],""),a[e.data("searchTermTags")]=i)}return a[e.data("searchTerm")]=n,void 0!==e.data("filterOptions")&&(a=$.extend({},a,e.data("filterOptions"))),null!=t.page&&(a.start=10*(t.page-1)),a},processResults:function(t,n){var o=[],i=e;a&&"function"==typeof a&&(t=a(t));var r=i.data("displayAll")??!1;$.each(t.data,(function(e,t){var a={id:t[i.data("idProperty")],text:t[i.data("textProperty")]};if(void 0!==i.data("thumbnail")&&(a.thumbnail=t[i.data("thumbnail")]),void 0!==i.data("additionalProperty")){const e=i.data("additionalProperty").split(",");$.each(e,(function(e,n){a[n]=t[n]}))}o.push(a)}));var l=n.page||1;return l=l>1?l-1:l,{results:o,pagination:{more:!r&&10*l<t.recordsTotal}}}},templateResult:function(e){var t="";return e.thumbnail&&(t+="<span class='option-thumbnail mr-3'><img style='width: 100px; height: 60px; object-fit: cover;' src='"+e.thumbnail+"' /></span>"),t+="<span class='option-text'>"+e.text+"</span></span>",$(t)}}),e.on("select2:open",(function(e){setTimeout((function(){$(e.target).data("select2").dropdown?.$search?.get(0).focus()}),10)})),-1==[void 0,""].indexOf(e.data("initialValue"))&&-1==[void 0,""].indexOf(e.data("initialKey"))){var o=e.data("initialValue"),i=e.data("initialKey"),r=e.data("textProperty"),l=e.data("idProperty"),s={};s[i]=o,void 0!==e.data("filterOptions")&&(s=$.extend({},s,e.data("filterOptions"))),$.ajax({url:e.data("searchUrl"),type:"GET",data:s}).then((function(t){var n=!1;a&&"function"==typeof a&&(t=a(t),n=!0),t.data.forEach((t=>{var a=!0;if(n&&(a=o==t[l]),a){var i=new Option(t[r],t[l],a,a);e.append(i)}})),e.trigger("change",[{skipSave:!0}]),e.trigger({type:"select2:select",params:{data:t}})}))}}function makeLocalSelect(e,t,a=!1){if(!0===a){const t=Math.floor(1e9+9e9*Math.random()),a=$(e).attr("id"),n=a?a+"_"+t:t;$(e).attr("data-select2-id",n)}e.select2({dropdownParent:null==t?$("body"):$(t),matcher:function(e,t){var a=function(e,a){var n=$(t.element).data()[a],o=null!=n?n.replace(" ","").split(","):[];return null!=e&&""!=e&&!o.includes(e)},n=$(t.element.parentElement).data().filterClass;if(Array.isArray(n)){for(var o=0;o<n.length;o++)if(a(n[o],"filter"+o+"Class"))return null}else if(a(n,"filterClass"))return null;if(""===$.trim(e.term))return t;var i=e.term.match(/\[([^}]+)\]/),r=e.term,l="";for(null!=i&&(l=i[1],r=e.term.replace(i[0],"")),r=r.replace(" ","").split(","),l=l.replace(" ","").split(","),o=0;o<r.length;o++){var s=r[o];if(""!=s&&t.text.toUpperCase().indexOf(s.toUpperCase())>-1)return t}for(o=0;o<l.length;o++){var d=l[o];if(""!=d&&null!=$(t.element).data("tags")&&$(t.element).data("tags").toUpperCase().indexOf(d.toUpperCase())>-1)return t}return null},templateResult:function(e){if(!e.id)return e.text;var t=$(e.element);return void 0!==t.data().content?$(t.data().content):e.text}}),e.on("select2:open",(function(e){setTimeout((function(){$(e.target).data("select2").dropdown?.$search?.get(0).focus()}),10)}))}function userPreferencesFormSubmit(){var e=$("#userPreferences");e.find('input[type="checkbox"]').each((function(){var e=$(this).is(":checked")?"on":"off",t=$(this).attr("id");$('<input type="hidden">').attr("id",t).attr("name",t).val(e).appendTo($(this).parent()),$(this).attr("disabled",!0)})),e.submit()}function initDatePicker(e,t,a,n,o,i,r){if(n=void 0===n?{}:n,o=void 0===o?null:o,i=void 0===i||i,r=void 0===r?null:r,null==t||null==a)return console.error("baseFormat and displayFormat needs to be defined!"),!1;e.data("customFormat")&&(a=e.data("customFormat"));var l=e,s=e.val();"Jalali"==calendarType?(null!=n.altField?l=$(n.altField):(l=$('<input type="text" class="form-control" id="'+e.attr("id")+'Link">'),e.after(l).hide()),l.persianDatepicker(Object.assign({initialValue:null!=s&&s,altField:"#"+e.attr("id"),altFieldFormatter:function(e){return moment.unix(e/1e3).format(t)},onSelect:function(){e.trigger("change"),l.trigger("change")}},n)),l.attr("readonly","readonly")):"Gregorian"==calendarType&&(e.parents(".bootbox.modal").removeAttr("tabindex"),flatpickr.l10ns.default.firstDayOfWeek=parseInt(moment().startOf("week").format("d")),flatpickr(e,Object.assign({altInput:!0,allowInput:!1,defaultDate:null!=s?s:null,altInputClass:"datePickerHelper "+e.attr("class"),disableMobile:!0,altFormat:a,dateFormat:t,locale:"en-GB"!=language?language:"default",defaultHour:"00",getWeek:function(e){return moment(e).week()},parseDate:function(e,t){return moment(e,t,!0).toDate()},formatDate:function(e,t,a){return moment(e).format(t)}},n))),l.change((function(){null!=o&&"function"==typeof o&&o()})),i&&l.parent().find(".date-clear-button").removeClass("d-none").click((function(){updateDatePicker(l,""),null!=r&&"function"==typeof r&&r()})),l.parent().find(".date-open-button").click((function(){"Gregorian"==calendarType?null!=l[0]._flatpickr&&l[0]._flatpickr.open():"Jalali"==calendarType&&l.data().datepicker.show()}))}function updateDatePicker(e,t,a,n){n=void 0!==n&&n,"Gregorian"==calendarType?null!=e[0]._flatpickr&&(""==t?(e.val("").trigger("change"),e[0]._flatpickr.setDate("")):null!=a?e[0]._flatpickr.setDate(t,n,a):e[0]._flatpickr.setDate(t)):"Jalali"==calendarType&&(""==t?(e.val("").trigger("change"),$("#"+e.attr("id")+"Link").val("").trigger("change")):$("#"+e.attr("id")+"Link").data().datepicker.setDate(1e3*moment(t,a).unix()))}function destroyDatePicker(e){"Gregorian"==calendarType?(null!=e[0]._flatpickr&&e[0]._flatpickr.destroy(),null!=e.attr("value")&&e.val(e.attr("value"))):"Jalali"==calendarType&&$("#"+e.attr("id")+"Link").data().datepicker.destroy(),e.parent().find(".date-open-button").off("click")}function updateRangeFilter(e,t,a,n){let o,i,r=e.val(),l="custom"===r,s=r.includes("last");if("agenda"===r&&(r="day"),l)$(".custom-date-range").removeClass("d-none");else{if($(".custom-date-range").addClass("d-none"),s){let e=r.replace("last","");o=moment().startOf(e).subtract(1,e+"s").format(jsDateFormat),i=moment().endOf(e).subtract(1,e+"s").format(jsDateFormat)}else o=moment().startOf(r).format(jsDateFormat),i=moment().endOf(r).format(jsDateFormat);updateDatePicker(t,o,jsDateFormat,!0),updateDatePicker(a,i,jsDateFormat,!0)}"function"==typeof n&&n()}function initJsTreeAjax(e,t,a,n,o=null,i=null,r=null,l=[],s=null){var d;if(a=void 0!==a&&a,n=void 0!==n&&n,0===$("#folder-tree-form-modal").length&&$("#"+t+" #folderId").length&&$("#select-folder-button").length){var c=Handlebars.compile($("#folder-tree-template").html());$("body").append(c({container:"container-folder-form-tree",modal:"folder-tree-form-modal"})),$("#folder-tree-form-modal").on("hidden.bs.modal",(function(){$(".modal:visible").length&&$(document.body).addClass("modal-open"),$(this).data("bs.modal",null)}))}var u={};if($(e).length){u=a?{key:t+"_folder_tree",ttl:n}:{key:t+"_folder_tree"},$(e).jstree({state:u,plugins:["contextmenu","state","unique","sort","types","search"].concat(l),contextmenu:{items:function(t,n){var o={},i=$(e).jstree(!0),l=null;$.ajax({url:foldersUrl+"/contextButtons/"+t.id,method:"GET",dataType:"json",success:function(e){(l=e).create&&(o.Create={separator_before:!1,separator_after:!1,label:translations.folderTreeCreate,action:function(e){t=i.create_node(t),i.edit(t)}}),l.modify&&(o.Rename={separator_before:!1,separator_after:!1,label:translations.folderTreeEdit,action:function(e){i.edit(t)}}),l.delete&&(o.Remove={separator_before:!0,separator_after:!1,label:translations.folderTreeDelete,action:function(e){i.delete_node(t)}}),!1===a&&l.share&&(o.Share={separator_before:!0,separator_after:!1,label:translations.folderTreeShare,_class:"XiboFormRender",action:function(e){XiboFormRender(permissionsUrl.replace(":entity","form/Folder/")+t.id)}}),!1===a&&l.move&&(o.Move={separator_before:!0,separator_after:!1,label:translations.folderTreeMove,_class:"XiboFormRender",action:function(e){XiboFormRender(foldersUrl+"/form/"+t.id+"/move")}}),null!==r&&r instanceof Function&&(o=r(t,o))},complete:function(e){n(o)}})}},types:{root:{icon:"fa fa-file text-xibo-primary"},home:{icon:"fa fa-home text-xibo-primary"},default:{icon:"fa fa-folder text-xibo-primary"},open:{icon:"fa fa-folder-open text-xibo-primary"}},search:{show_only_matches:!0},core:{check_callback:function(e,t,a,n,o){return"delete_node"!==e&&"rename_node"!==e||"#"!==t.id&&"1"!==t.id||(toastr.error(translations.folderTreeError),!1)},data:{url:foldersUrl+(s?"?homeFolderId="+s:"")},themes:{responsive:!0,dots:!1}}}).bind("ready.jstree",(function(n,i){if(void 0!==localStorage.getItem("hideFolderTree")&&null!==localStorage.getItem("hideFolderTree")&&JSON.parse(localStorage.getItem("hideFolderTree"))!==$("#grid-folder-filter").is(":hidden")&&adjustDatatableSize(!1),$.each(i.instance._model.data,(function(n,o){if("disabled"===o?.original?.type){var i=$(e).jstree().get_node(o.id);0===o.children.length?$(e).jstree().hide_node(i):$(e).jstree().disable_node(i)}if(1===o?.original?.isRoot&&$(e).find("a#"+o.id+"_anchor").attr("title",translations.folderRootTitle),void 0!==o.type&&"home"===o.type){d=o.id,null!=localStorage.getItem(t+"_folder_tree")||a||$(e).jstree(!0).select_node(d)}})),a){var r="#"+t+" #folderId";0===$(r).length&&(r="#formFolderId");let e=$(r).val()?$(r).val():d;void 0!==e&&""!==e&&($(this).jstree("select_node",e),$("#originalFormFolder").length&&$("#originalFormFolder").text($(this).jstree().get_path($(this).jstree("get_selected",!0)[0]," > ")),$("#selectedFormFolder").length&&"#formFolderId"===r&&$("#selectedFormFolder").text($(this).jstree().get_path($(this).jstree("get_selected",!0)[0]," > ")))}o&&o instanceof Function&&o($(e).jstree(!0),$(e))})).bind("rename_node.jstree",(function(t,a){var n={},o=a.node.id;n.text=a.text,$.ajax({url:foldersUrl+"/"+o,method:"PUT",dataType:"json",data:n,success:function(t){"#container-folder-form-tree"===e&&$("#container-folder-tree").jstree(!0).refresh()}})})).bind("create_node.jstree",(function(t,a){var n=a.node;n.text=translations.folderNew;var o={};o.parentId=a.parent,o.text=a.node.text,$.ajax({url:foldersUrl,method:"POST",dataType:"json",data:o,success:function(t){$(e).jstree(!0).set_id(n,t.data.id),"#container-folder-form-tree"===e&&$("#container-folder-tree").jstree(!0).refresh()}})})).bind("delete_node.jstree",(function(t,a){var n={};n.parentId=a.parent,n.text=a.node.text;var o=a.node.id;$.ajax({url:foldersUrl+"/"+o,method:"DELETE",dataType:"json",data:n,success:function(t){t.success?(toastr.success(translations.done),"#container-folder-form-tree"===e&&$("#container-folder-tree").jstree(!0).refresh()):(void 0!==t.message?toastr.error(t.message):toastr.error(translations.folderWithContent),$(e).jstree(!0).refresh())}})})).bind("changed.jstree",(function(n,o){var r=o.selected[0],l=a?"#"+t+" #folderId":"#folderId",s=$(e).jstree("get_selected",!0);a&&0===$(l).length&&(l="#formFolderId"),void 0!==r&&!1===a&&($("#breadcrumbs").text($(e).jstree().get_path(s[0]," > ")).hide(),$("#folder-tree-clear-selection-button").prop("checked",!1)),$(l).val()!=r&&!1===a&&(void 0!==r?$(l).val(r).trigger("change"):($("#breadcrumbs").text(""),$("#folder-tree-clear-selection-button").prop("checked",!0),$(".XiboFilter").find("#folderId").val(null).trigger("change"))),a&&void 0!==r&&($(l).val(r).trigger("change"),$("#selectedFormFolder").length&&$("#selectedFormFolder").text($(e).jstree().get_path(s[0]," > "))),i&&i instanceof Function&&i(o)})).bind("open_node.jstree",(function(e,t){"root"!==t.node.type&&"home"!==t.node.type&&t.instance.set_type(t.node,"open")})).bind("close_node.jstree",(function(e,t){"root"!==t.node.type&&"home"!==t.node.type&&t.instance.set_type(t.node,"default")})).bind("search.jstree",(function(t,a,n){0===a.nodes.length?($(e).jstree(!0).hide_all(),$(e).parent().find(".folder-search-no-results").removeClass("d-none")):$(e).parent().find(".folder-search-no-results").addClass("d-none")})),$(".btnCloseInnerModal").on("click",(function(e){e.preventDefault(),$(a?"#folder-tree-form-modal":"#folder-tree-modal").modal("hide")})),$("#folder-tree-clear-selection-button").on("click",(function(){$("#folder-tree-clear-selection-button").is(":checked")?($(e).jstree("deselect_all"),$(".XiboFilter").find("#folderId").val(null).trigger("change")):$(e).jstree("select_node",d??1)})),$("#folder-tree-select-folder-button").off("click").on("click",adjustDatatableSize);var f=_.debounce((function(){$(e).jstree(!0).show_all(),$(e).parent().find(".folder-search-no-results").addClass("d-none"),$(e).jstree(!0).search($(this).val())}),500);$("#jstree-search").on("keyup",f),$("#jstree-search-form").on("keyup",f)}$("#grid-folder-filter").resizable({handles:"e",minWidth:200,maxWidth:500})}function adjustDatatableSize(e){function t(){"function"==typeof refreshDisplayMap&&refreshDisplayMap()}e=void 0===e||e,$("#grid-folder-filter").is(":hidden")&&t(),$("#grid-folder-filter").toggle("fast",(function(){$(this).is(":hidden")?($("#folder-tree-clear-selection-button").is(":checked")||$("#breadcrumbs").show("slow"),t()):$("#breadcrumbs").hide("slow"),e&&$(this).closest(".XiboGrid").find("table.dataTable").DataTable().ajax.reload(),localStorage.setItem("hideFolderTree",JSON.stringify($("#grid-folder-filter").is(":hidden")))}))}function disableFolders(){$("#folder-tree-select-folder-button").parent().remove(),$("#container-folder-tree").remove(),$("#grid-folder-filter").remove()}function createMiniLayoutPreview(e){if(0==$(".page-content").find(".mini-layout-preview").length){var t=Handlebars.compile($("#mini-player-template").html());$(".page-content").append(t())}var a=$(".mini-layout-preview"),n=a.find("#content"),o=Handlebars.compile('<iframe scrolling="no" src="{{url}}" width="{{width}}px" height="{{height}}px" style="border:0;"></iframe>');n.html(""),a.find("#playBtn").show().off().on("click",(function(){$(this).hide(),a.find("#content").append(o({url:e,width:a.hasClass("large")?"760":"440",height:a.hasClass("large")?"420":"240"}))})),a.find("#closeBtn").off().on("click",(function(){a.find("#content").html(""),a.removeClass("show"),a.remove()})),a.find("#newTabBtn").off().on("click",(function(){window.open(e,"_blank")})),a.find("#sizeBtn").off().on("click",(function(){a.find("#content").html(""),a.toggleClass("large"),$(this).toggleClass("fa-arrow-circle-down",a.hasClass("large")),$(this).toggleClass("fa-arrow-circle-up",!a.hasClass("large")),a.find("#playBtn").show()})),a.addClass("show")}function formatBytes(e,t){if(0===e)return"0 Bytes";const a=0>t?0:t,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(a))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][n]}function createColorPicker(e,t){var a=$(e);a.attr("autocomplete","off"),a.colorpicker(Object.assign({format:"hex"},t))}function destroyColorPicker(e){$(e).colorpicker("destroy")}String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t}),String.prototype.endsWith||(String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)}),$.fn.dataTable.ext.errMode=function(e,t,a){console.error(a)},$(document).delegate('*[data-toggle="lightbox"]',"click",(function(e){e.preventDefault(),$(this).ekkoLightbox({onContentLoaded:function(){var e=$(".ekko-lightbox-container");e.css({"max-height":e.height(),height:"","max-width":e.width()}),e.parents(".modal-content").css({width:"fit-content"})}})})),$(document).ready((function(){buttonsTemplate=null,window.console||function(){var e,t=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"],a=t.length;for(window.console={},e=0;e<a;e++)window.console[t[e]]=function(){}}(),setInterval("XiboPing('"+clockUrl+"')",6e4),setInterval("XiboPing('"+pingUrl+"')",18e4),XiboInitialise("")}));